openapi: 3.1.0
info:
  title: Lexicon Crawler API
  description: |
    Lexicon Crawler is a production-ready web crawler built with FastAPI and modern Python async patterns.
    It combines browser automation (Playwright, undetected-chromedriver) with distributed task queuing (NATS JetStream),
    persistent storage (PostgreSQL + GCS), and full observability (Prometheus, Grafana, Loki).

    ## Features
    - Website configuration with multi-step crawl/scrape workflows
    - Scheduled crawling with cron expressions
    - Browser automation (Playwright, undetected-chromedriver)
    - Rate limiting and retry logic
    - Full observability (metrics, structured logging)

  version: 1.0.0
  contact:
    name: Lexicon Crawler Support
    url: https://github.com/lexicon/crawler
  license:
    name: MIT
    identifier: MIT

servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://crawler.lexicon.id
    description: Production server

tags:
  - name: General
    description: General application endpoints (health, root, metrics)
  - name: Websites
    description: Website configuration and management
  - name: Jobs
    description: Crawl job creation and management
  - name: Dead Letter Queue
    description: Management of permanently failed jobs requiring manual intervention
  - name: Duplicates
    description: Duplicate content detection and management
  - name: Monitoring
    description: Monitoring and observability endpoints

paths:
  /:
    get:
      tags:
        - General
      summary: Root endpoint
      description: Returns basic application information including name, version, and environment
      operationId: getRoot
      responses:
        '200':
          description: Application information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RootResponse'
              examples:
                default:
                  value:
                    message: "Welcome to Lexicon Crawler"
                    version: "1.0.0"
                    environment: "development"

  /health:
    get:
      tags:
        - General
      summary: Health check
      description: Check the health status of the application including database and Redis
      operationId: healthCheck
      responses:
        '200':
          description: Health check results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                healthy:
                  value:
                    status: "healthy"
                    timestamp: "2025-10-27T10:00:00Z"
                    checks:
                      database: "connected"
                      redis: "connected"
                unhealthy:
                  value:
                    status: "unhealthy"
                    timestamp: "2025-10-27T10:00:00Z"
                    checks:
                      database: "error: connection timeout"
                      redis: "connected"

  /metrics:
    get:
      tags:
        - Monitoring
      summary: Prometheus metrics
      description: Expose Prometheus metrics for monitoring
      operationId: getMetrics
      responses:
        '200':
          description: Prometheus metrics in text format
          content:
            text/plain:
              schema:
                type: string
                example: |
                  # HELP http_requests_total Total HTTP requests
                  # TYPE http_requests_total counter
                  http_requests_total{method="GET",endpoint="/"} 42

  /api/v1/websites:
    post:
      tags:
        - Websites
      summary: Create a new website configuration
      description: |
        Create a new website with crawl configuration and schedule.

        This endpoint:
        1. Validates the website configuration including selectors and steps
        2. Validates the cron schedule expression
        3. Stores the configuration in PostgreSQL
        4. Creates a scheduled job if schedule is enabled
        5. Returns the created website with ID and next run time

        The configuration includes:
        - Steps for crawling/scraping (API, Browser, or HTTP methods)
        - Selectors for data extraction
        - Schedule configuration with cron expression
        - Global settings (rate limits, timeouts, retries)
        - Variables for dynamic value substitution
      operationId: createWebsite
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWebsiteRequest'
            examples:
              simple_crawl:
                summary: Simple HTTP crawl
                value:
                  name: "Example News Site"
                  base_url: "https://news.example.com"
                  description: "Crawl news articles from example site"
                  schedule:
                    type: "recurring"
                    cron: "0 0 1,15 * *"
                    timezone: "UTC"
                    enabled: true
                  steps:
                    - name: "crawl_list"
                      type: "crawl"
                      description: "Get article list"
                      method: "http"
                      config:
                        url: "https://news.example.com/articles"
                      selectors:
                        detail_urls: ".article-link"
                      output:
                        urls_field: "detail_urls"
                    - name: "scrape_detail"
                      type: "scrape"
                      description: "Scrape article content"
                      method: "http"
                      input_from: "crawl_list.detail_urls"
                      selectors:
                        title: "h1.title"
                        content: ".article-body"
                        author: ".author-name"
                      output:
                        main_content_field: "content"
                  global_config:
                    rate_limit:
                      requests_per_second: 2.0
                      concurrent_pages: 5
                      burst: 10
                    timeout:
                      page_load: 30
                      selector_wait: 10
                      http_request: 30
                    retry:
                      max_attempts: 3
                      backoff_strategy: "exponential"
                      initial_delay: 1
              browser_crawl:
                summary: Browser-based crawl with Playwright
                value:
                  name: "Dynamic Content Site"
                  base_url: "https://dynamic.example.com"
                  schedule:
                    type: "recurring"
                    cron: "0 2 * * 1"
                    enabled: true
                  steps:
                    - name: "crawl_spa"
                      type: "crawl"
                      method: "browser"
                      browser_type: "playwright"
                      config:
                        url: "https://dynamic.example.com/products"
                        wait_until: "networkidle"
                        actions:
                          - type: "wait"
                            selector: ".product-list"
                            timeout: 5000
                          - type: "scroll"
                            value: "bottom"
                          - type: "wait"
                            value: "2000"
                      selectors:
                        product_urls: ".product-card a"
                      output:
                        urls_field: "product_urls"
                  global_config:
                    rate_limit:
                      requests_per_second: 1.0
                      concurrent_pages: 3
      responses:
        '201':
          description: Website created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebsiteResponse'
              examples:
                created:
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    name: "Example News Site"
                    base_url: "https://news.example.com"
                    config:
                      steps:
                        - name: "crawl_list"
                          type: "crawl"
                          method: "http"
                      global_config:
                        rate_limit:
                          requests_per_second: 2.0
                    status: "active"
                    cron_schedule: "0 0 1,15 * *"
                    created_at: "2025-10-27T10:00:00Z"
                    updated_at: "2025-10-27T10:00:00Z"
                    created_by: null
                    next_run_time: "2025-11-01T00:00:00Z"
                    scheduled_job_id: "660e8400-e29b-41d4-a716-446655440000"
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_cron:
                  summary: Invalid cron expression
                  value:
                    detail: "Invalid cron expression: expected 5 fields, got 3"
                    error_code: "INVALID_CRON_EXPRESSION"
                duplicate_name:
                  summary: Duplicate website name
                  value:
                    detail: "Website with name 'Example Site' already exists"
                    error_code: "DUPLICATE_WEBSITE_NAME"
                invalid_url:
                  summary: Invalid base URL
                  value:
                    detail: "base_url must start with http:// or https://"
                    error_code: "VALIDATION_ERROR"
                    field: "base_url"
        '422':
          description: Unprocessable Entity (validation error in request body)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                server_error:
                  value:
                    detail: "Internal server error: database connection failed"
                    error_code: "INTERNAL_ERROR"
    get:
      tags:
        - Websites
      summary: List all website configurations
      description: |
        Retrieve a paginated list of website configurations with optional filtering.

        This endpoint:
        1. Retrieves websites with pagination support
        2. Optionally filters by status (active, inactive)
        3. Returns basic website information
        4. Includes total count for pagination

        Filtering:
        - status: Filter by website status (active/inactive)

        Pagination:
        - limit: Number of results per page (default: 20, max: 100)
        - offset: Number of results to skip
      operationId: listWebsites
      parameters:
        - name: status
          in: query
          required: false
          description: Filter by website status
          schema:
            type: string
            enum: [active, inactive]
            example: "active"
        - name: limit
          in: query
          required: false
          description: Number of websites to return (max 100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
            example: 20
        - name: offset
          in: query
          required: false
          description: Number of websites to skip for pagination
          schema:
            type: integer
            minimum: 0
            default: 0
            example: 0
      responses:
        '200':
          description: List of websites retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListWebsitesResponse'
              examples:
                success:
                  value:
                    websites:
                      - id: "550e8400-e29b-41d4-a716-446655440000"
                        name: "Example News Site"
                        base_url: "https://news.example.com"
                        status: "active"
                        cron_schedule: "0 0 1,15 * *"
                        created_at: "2025-10-27T10:00:00Z"
                        updated_at: "2025-10-27T10:00:00Z"
                      - id: "660e8400-e29b-41d4-a716-446655440000"
                        name: "Tech Blog"
                        base_url: "https://blog.example.com"
                        status: "active"
                        cron_schedule: "0 2 * * 1"
                        created_at: "2025-10-28T10:00:00Z"
                        updated_at: "2025-10-28T10:00:00Z"
                    total: 2
                    limit: 20
                    offset: 0
        '422':
          description: Validation error (invalid query parameters)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/websites/{id}:
    get:
      tags:
        - Websites
      summary: Get website configuration by ID
      description: |
        Retrieve a single website configuration by ID with statistics.

        This endpoint:
        1. Retrieves website configuration and metadata
        2. Calculates statistics from crawl history:
           - Total crawl jobs executed
           - Success rate (completed jobs / total jobs)
           - Total pages crawled across all jobs
           - Last successful crawl timestamp
           - Next scheduled run time

        Statistics are calculated from the database and reflect historical data.
      operationId: getWebsiteById
      parameters:
        - name: id
          in: path
          required: true
          description: Website ID
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Website retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebsiteWithStatsResponse'
              examples:
                success:
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    name: "Example News Site"
                    base_url: "https://news.example.com"
                    config:
                      steps:
                        - name: "crawl_list"
                          type: "crawl"
                          method: "http"
                      global_config:
                        rate_limit:
                          requests_per_second: 2.0
                    status: "active"
                    cron_schedule: "0 0 1,15 * *"
                    created_at: "2025-10-27T10:00:00Z"
                    updated_at: "2025-10-27T10:00:00Z"
                    created_by: null
                    next_run_time: "2025-11-01T00:00:00Z"
                    scheduled_job_id: "660e8400-e29b-41d4-a716-446655440000"
                    statistics:
                      total_jobs: 15
                      completed_jobs: 12
                      failed_jobs: 2
                      cancelled_jobs: 1
                      success_rate: 80.0
                      total_pages_crawled: 1250
                      last_crawl_at: "2025-10-30T10:30:00Z"
        '404':
          description: Website not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  value:
                    detail: "Website with ID '550e8400-e29b-41d4-a716-446655440000' not found"
                    error_code: "WEBSITE_NOT_FOUND"
        '422':
          description: Validation error (invalid UUID format)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      tags:
        - Websites
      summary: Update website configuration
      description: |
        Update an existing website configuration with versioning and optional re-crawl.

        This endpoint:
        1. Validates the updated configuration
        2. Saves the current configuration as a new version in history
        3. Updates the website with new configuration
        4. Updates scheduled jobs if schedule changed
        5. Optionally triggers an immediate re-crawl
        6. Returns the updated website with version info

        **Configuration Versioning:**
        - Every update creates a new version in the history table
        - Versions are auto-incremented (1, 2, 3, ...)
        - Full configuration snapshots are preserved
        - Audit trail includes who changed it and why

        **Schedule Updates:**
        - If cron schedule changes, scheduled job is updated
        - If schedule.enabled changes, job is activated/deactivated
        - New scheduled job created if none existed

        **Re-crawl Triggering:**
        - Set trigger_recrawl=true to start immediate crawl
        - Creates new one-time job with updated configuration
        - Useful after significant configuration changes
      operationId: updateWebsite
      parameters:
        - name: id
          in: path
          required: true
          description: Website ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateWebsiteRequest'
            examples:
              update_steps:
                summary: Update crawl steps
                value:
                  steps:
                    - name: "crawl_list"
                      type: "crawl"
                      method: "http"
                      config:
                        url: "https://api.example.com/v2/items"
                  change_reason: "Updated API endpoint to v2"
              update_schedule:
                summary: Change schedule frequency
                value:
                  schedule:
                    cron: "0 0 * * *"
                    enabled: true
                  change_reason: "Increase crawl frequency to daily"
              pause_website:
                summary: Pause website crawling
                value:
                  status: "inactive"
                  schedule:
                    enabled: false
                  change_reason: "Temporarily pausing due to site maintenance"
              trigger_recrawl:
                summary: Update and trigger immediate re-crawl
                value:
                  global_config:
                    rate_limit:
                      requests_per_second: 1.0
                  trigger_recrawl: true
                  change_reason: "Reduced rate limit and testing new configuration"
      responses:
        '200':
          description: Website updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateWebsiteResponse'
              examples:
                success:
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    name: "Example News Site"
                    base_url: "https://news.example.com"
                    config:
                      steps:
                        - name: "crawl_list"
                          type: "crawl"
                          method: "http"
                      global_config:
                        rate_limit:
                          requests_per_second: 1.0
                    status: "active"
                    cron_schedule: "0 0 * * *"
                    created_at: "2025-10-27T10:00:00Z"
                    updated_at: "2025-11-09T12:00:00Z"
                    created_by: null
                    next_run_time: "2025-11-10T00:00:00Z"
                    scheduled_job_id: "660e8400-e29b-41d4-a716-446655440000"
                    config_version: 3
                    recrawl_job_id: null
        '400':
          description: Validation error or invalid configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_cron:
                  value:
                    detail: "Invalid cron expression: expected 5 fields"
                    error_code: "INVALID_CRON_EXPRESSION"
                no_changes:
                  value:
                    detail: "No changes detected in the update request"
                    error_code: "NO_CHANGES"
        '404':
          description: Website not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Unprocessable Entity (validation error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags:
        - Websites
      summary: Delete website (soft delete)
      description: |
        Soft delete a website and cancel all running jobs.

        This endpoint:
        1. Validates the website exists and is not already deleted
        2. Cancels all active (pending/running) jobs for this website
        3. Archives the current configuration for audit purposes
        4. Soft deletes the website (sets deleted_at timestamp)
        5. Sets status to 'inactive'
        6. Returns deletion summary with cancelled jobs

        **Soft Delete Behavior:**
        - Website is not permanently removed from the database
        - Sets `deleted_at` timestamp to current time
        - Sets status to 'inactive'
        - Configuration is preserved in history table
        - Can be restored by clearing deleted_at (not yet implemented)

        **Job Cancellation:**
        - All pending and running jobs are automatically cancelled
        - Jobs are marked with cancellation reason
        - Returns list of cancelled job IDs

        **Future Feature:**
        - `delete_data` parameter will allow deletion of all crawled pages (not yet implemented)
      operationId: deleteWebsite
      parameters:
        - name: id
          in: path
          required: true
          description: Website ID
          schema:
            type: string
            format: uuid
        - name: delete_data
          in: query
          required: false
          description: Delete all crawled data (not yet implemented, reserved for future use)
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Website deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteWebsiteResponse'
              examples:
                success:
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    name: "Example Website"
                    deleted_at: "2025-11-09T12:00:00Z"
                    cancelled_jobs: 2
                    cancelled_job_ids:
                      - "660e8400-e29b-41d4-a716-446655440000"
                      - "770e8400-e29b-41d4-a716-446655440000"
                    config_archived_version: 5
                    message: "Website 'Example Website' deleted successfully"
        '400':
          description: Website not found or already deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  value:
                    detail: "Website with ID '550e8400-e29b-41d4-a716-446655440000' not found"
                    error_code: "WEBSITE_NOT_FOUND"
                already_deleted:
                  value:
                    detail: "Website with ID '550e8400-e29b-41d4-a716-446655440000' is already deleted"
                    error_code: "WEBSITE_ALREADY_DELETED"
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /api/v1/websites/{id}/config-history:
    get:
      tags:
        - Websites
      summary: Get website configuration history
      description: |
        Retrieve the configuration version history for a website.

        This endpoint:
        1. Lists all configuration versions for the website
        2. Returns versions in descending order (newest first)
        3. Includes full config snapshot for each version
        4. Shows who made each change and why
        5. Supports pagination for large histories

        **Use Cases:**
        - Audit trail for configuration changes
        - Understanding configuration evolution
        - Identifying when/why a change was made
        - Preparing for rollback operations
      operationId: getWebsiteConfigHistory
      parameters:
        - name: id
          in: path
          required: true
          description: Website ID
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          required: false
          description: Number of versions to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
        - name: offset
          in: query
          required: false
          description: Number of versions to skip
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Configuration history retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigHistoryListResponse'
              examples:
                success:
                  value:
                    versions:
                      - id: "880e8400-e29b-41d4-a716-446655440000"
                        website_id: "550e8400-e29b-41d4-a716-446655440000"
                        version: 3
                        config:
                          steps:
                            - name: "crawl_list"
                              type: "crawl"
                              method: "http"
                          global_config:
                            rate_limit:
                              requests_per_second: 1.0
                        changed_by: "admin"
                        change_reason: "Reduced rate limit for testing"
                        created_at: "2025-11-09T12:00:00Z"
                      - id: "770e8400-e29b-41d4-a716-446655440000"
                        website_id: "550e8400-e29b-41d4-a716-446655440000"
                        version: 2
                        config:
                          steps:
                            - name: "crawl_list"
                              type: "crawl"
                              method: "http"
                          global_config:
                            rate_limit:
                              requests_per_second: 2.0
                        changed_by: "system"
                        change_reason: "Initial configuration update"
                        created_at: "2025-11-01T10:00:00Z"
                    total: 2
                    limit: 10
                    offset: 0
        '404':
          description: Website not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /api/v1/websites/{id}/config-history/{version}:
    get:
      tags:
        - Websites
      summary: Get a specific configuration version
      description: |
        Retrieve a specific version of the website configuration.

        This endpoint:
        1. Fetches a specific version by version number
        2. Returns the complete configuration snapshot
        3. Includes change metadata (who, when, why)

        **Use Cases:**
        - Viewing exact configuration at a point in time
        - Comparing configurations before rollback
        - Detailed audit investigation
      operationId: getWebsiteConfigVersion
      parameters:
        - name: id
          in: path
          required: true
          description: Website ID
          schema:
            type: string
            format: uuid
        - name: version
          in: path
          required: true
          description: Version number
          schema:
            type: integer
            minimum: 1
      responses:
        '200':
          description: Configuration version retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigHistoryResponse'
              examples:
                success:
                  value:
                    id: "880e8400-e29b-41d4-a716-446655440000"
                    website_id: "550e8400-e29b-41d4-a716-446655440000"
                    version: 2
                    config:
                      steps:
                        - name: "crawl_list"
                          type: "crawl"
                          method: "http"
                      global_config:
                        rate_limit:
                          requests_per_second: 2.0
                    changed_by: "admin"
                    change_reason: "Updated crawl configuration"
                    created_at: "2025-11-01T10:00:00Z"
        '404':
          description: Website or version not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                version_not_found:
                  value:
                    detail: "Configuration version 5 not found for website"
                    error_code: "VERSION_NOT_FOUND"
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /api/v1/websites/{id}/rollback:
    post:
      tags:
        - Websites
      summary: Rollback website configuration to a previous version
      description: |
        Rollback the website configuration to a specific previous version.

        This endpoint:
        1. Validates the target version exists
        2. Saves the current configuration as a new version (audit trail)
        3. Restores the configuration from the target version
        4. Updates the website with the restored configuration
        5. Optionally triggers an immediate re-crawl with the restored config

        **Safety Features:**
        - Current config is preserved in history before rollback
        - All rollbacks are logged with reason and user
        - Rollback itself creates a new version (reversible)
        - Optional re-crawl to validate restored configuration

        **Important:**
        - Rolling back does NOT delete newer versions
        - Creates a new version that's a copy of the target version
        - Full audit trail is maintained
      operationId: rollbackWebsiteConfig
      parameters:
        - name: id
          in: path
          required: true
          description: Website ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RollbackConfigRequest'
            examples:
              simple_rollback:
                summary: Rollback without re-crawl
                value:
                  version: 2
                  rollback_reason: "Reverting to previous working configuration"
              rollback_with_recrawl:
                summary: Rollback and trigger re-crawl
                value:
                  version: 3
                  rollback_reason: "Emergency rollback due to crawl failures"
                  trigger_recrawl: true
      responses:
        '200':
          description: Configuration rolled back successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RollbackConfigResponse'
              examples:
                success:
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    name: "Example News Site"
                    base_url: "https://news.example.com"
                    config:
                      steps:
                        - name: "crawl_list"
                          type: "crawl"
                          method: "http"
                      global_config:
                        rate_limit:
                          requests_per_second: 2.0
                    status: "active"
                    cron_schedule: "0 0 1,15 * *"
                    created_at: "2025-10-27T10:00:00Z"
                    updated_at: "2025-11-09T14:00:00Z"
                    config_version: 5
                    rolled_back_from_version: 4
                    rolled_back_to_version: 2
                    recrawl_job_id: null
        '400':
          description: Invalid rollback request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                version_not_found:
                  value:
                    detail: "Configuration version 10 not found"
                    error_code: "VERSION_NOT_FOUND"
                same_version:
                  value:
                    detail: "Cannot rollback to the current version"
                    error_code: "INVALID_ROLLBACK"
        '404':
          description: Website not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /api/v1/jobs/seed:
    post:
      tags:
        - Jobs
      summary: Submit a seed URL for crawling using an existing website template
      description: |
        Create a one-time crawl job using an existing website template configuration.

        This endpoint:
        1. Validates the seed URL and website_id
        2. Loads the website configuration from database
        3. Optionally accepts variable substitutions
        4. Creates a crawl job with pending status
        5. Returns job ID and status for tracking

        The job will use the website template's configuration including:
        - Crawl/scrape steps
        - Selectors for data extraction
        - Global settings (rate limits, timeouts, retries)
        - Browser configuration if needed

        Variables provided in the request will override template variables.
      operationId: createSeedJob
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSeedJobRequest'
            examples:
              simple_seed:
                summary: Simple seed URL with template
                value:
                  website_id: "550e8400-e29b-41d4-a716-446655440000"
                  seed_url: "https://example.com/articles/2025/technology"
                  variables:
                    category: "technology"
                    year: "2025"
              seed_with_priority:
                summary: Seed URL with custom priority
                value:
                  website_id: "550e8400-e29b-41d4-a716-446655440000"
                  seed_url: "https://example.com/breaking-news"
                  priority: 9
      responses:
        '201':
          description: Crawl job created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SeedJobResponse'
              examples:
                created:
                  value:
                    id: "770e8400-e29b-41d4-a716-446655440000"
                    website_id: "550e8400-e29b-41d4-a716-446655440000"
                    seed_url: "https://example.com/articles/2025/technology"
                    status: "pending"
                    job_type: "one_time"
                    priority: 5
                    scheduled_at: null
                    variables:
                      category: "technology"
                      year: "2025"
                    created_at: "2025-10-29T10:00:00Z"
                    updated_at: "2025-10-29T10:00:00Z"
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_website:
                  summary: Website not found
                  value:
                    detail: "Website with ID '550e8400-e29b-41d4-a716-446655440000' not found"
                    error_code: "WEBSITE_NOT_FOUND"
                invalid_url:
                  summary: Invalid seed URL
                  value:
                    detail: "seed_url must be a valid URL starting with http:// or https://"
                    error_code: "INVALID_URL"
                    field: "seed_url"
                inactive_website:
                  summary: Website is inactive
                  value:
                    detail: "Website 'Example Site' is inactive and cannot be used"
                    error_code: "WEBSITE_INACTIVE"
        '422':
          description: Unprocessable Entity (validation error in request body)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/jobs/seed-inline:
    post:
      tags:
        - Jobs
      summary: Submit a seed URL for crawling with inline configuration
      description: |
        Create a one-time crawl job with full inline configuration (Mode B - no template).

        This endpoint:
        1. Validates the seed URL and inline configuration
        2. Validates crawl steps and selectors
        3. Creates a crawl job with embedded configuration
        4. Returns job ID and status for tracking

        Unlike the template-based endpoint, this allows ad-hoc crawls without
        creating a website configuration first. The configuration is provided
        inline and stored with the job.

        Use cases:
        - One-off data collection tasks
        - Testing crawl configurations before creating a template
        - Dynamic crawling with programmatically generated configs
        - External integrations that generate configurations on-the-fly
      operationId: createSeedJobInline
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSeedJobInlineRequest'
            examples:
              simple_inline:
                summary: Simple inline crawl with HTTP method
                value:
                  seed_url: "https://example.com/articles"
                  steps:
                    - name: "scrape_article"
                      type: "scrape"
                      method: "http"
                      config:
                        url: "https://example.com/articles"
                      selectors:
                        title: "h1.title"
                        content: ".article-body"
                      output:
                        main_content_field: "content"
                  global_config:
                    rate_limit:
                      requests_per_second: 2.0
                    timeout:
                      http_request: 30
                  priority: 5
              browser_inline:
                summary: Browser-based inline crawl with Playwright
                value:
                  seed_url: "https://dynamic.example.com/products"
                  steps:
                    - name: "crawl_products"
                      type: "crawl"
                      method: "browser"
                      browser_type: "playwright"
                      config:
                        url: "https://dynamic.example.com/products"
                        wait_until: "networkidle"
                        actions:
                          - type: "wait"
                            selector: ".product-list"
                            timeout: 5000
                      selectors:
                        product_urls: ".product-card a"
                      output:
                        urls_field: "product_urls"
                  global_config:
                    rate_limit:
                      requests_per_second: 1.0
                      concurrent_pages: 3
                  priority: 7
                  variables:
                    api_key: "test_key_123"
      responses:
        '201':
          description: Crawl job created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SeedJobResponse'
              examples:
                created:
                  value:
                    id: "880e8400-e29b-41d4-a716-446655440000"
                    website_id: null
                    seed_url: "https://example.com/articles"
                    status: "pending"
                    job_type: "one_time"
                    priority: 5
                    scheduled_at: null
                    variables:
                      api_key: "test_key_123"
                    created_at: "2025-10-29T10:00:00Z"
                    updated_at: "2025-10-29T10:00:00Z"
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_url:
                  summary: Invalid seed URL
                  value:
                    detail: "seed_url must be a valid URL starting with http:// or https://"
                    error_code: "INVALID_URL"
                    field: "seed_url"
                invalid_config:
                  summary: Invalid configuration
                  value:
                    detail: "Invalid step configuration: missing required field 'method'"
                    error_code: "INVALID_CONFIGURATION"
                    field: "steps"
                empty_steps:
                  summary: Empty steps array
                  value:
                    detail: "At least one crawl step is required"
                    error_code: "VALIDATION_ERROR"
                    field: "steps"
        '422':
          description: Unprocessable Entity (validation error in request body)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/jobs/{job_id}/cancel:
    post:
      tags:
        - Jobs
      summary: Cancel a crawl job
      description: |
        Cancel a running or pending crawl job.

        This endpoint:
        1. Validates that the job exists
        2. Checks that the job is not already completed or cancelled
        3. Updates the job status to "cancelled"
        4. Sets a Redis cancellation flag for workers to detect
        5. Returns the updated job information

        Jobs in "completed" or "failed" status cannot be cancelled.
      operationId: cancelJob
      parameters:
        - name: job_id
          in: path
          required: true
          description: ID of the job to cancel
          schema:
            type: string
            format: uuid
            example: "770e8400-e29b-41d4-a716-446655440000"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelJobRequest'
            examples:
              with_reason:
                summary: Cancel with reason
                value:
                  reason: "User requested cancellation"
              without_reason:
                summary: Cancel without reason
                value: {}
      responses:
        '200':
          description: Job cancellation initiated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CancelJobResponse'
              examples:
                cancelled:
                  value:
                    id: "770e8400-e29b-41d4-a716-446655440000"
                    status: "cancelled"
                    message: "Job cancellation initiated"
                    cancelled_at: "2025-10-29T10:30:00Z"
        '400':
          description: Job cannot be cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                already_completed:
                  summary: Job already completed
                  value:
                    detail: "Job is already completed and cannot be cancelled"
                    error_code: "INVALID_JOB_STATUS"
                already_cancelled:
                  summary: Job already cancelled
                  value:
                    detail: "Job is already cancelled"
                    error_code: "ALREADY_CANCELLED"
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  value:
                    detail: "Job with ID '770e8400-e29b-41d4-a716-446655440000' not found"
                    error_code: "JOB_NOT_FOUND"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/jobs/{job_id}/ws-token:
    post:
      tags:
        - Jobs
      summary: Generate WebSocket token for log streaming
      description: |
        Generate a short-lived, single-use WebSocket authentication token.

        This endpoint:
        1. Validates that the job exists
        2. Generates a secure random token
        3. Stores it in Redis with 10-minute TTL
        4. Returns the token for WebSocket connection

        Use the returned token to connect to the WebSocket endpoint:
        `/ws/v1/jobs/{job_id}/logs?token={token}`

        Tokens expire after 10 minutes and are single-use only.
      operationId: generateWSToken
      parameters:
        - name: job_id
          in: path
          required: true
          description: ID of the job to generate token for
          schema:
            type: string
            format: uuid
            example: "770e8400-e29b-41d4-a716-446655440000"
      requestBody:
        required: false
        description: No request body required
        content:
          application/json:
            schema:
              type: object
            examples:
              empty:
                summary: No body needed
                value: {}
      responses:
        '200':
          description: Token generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WSTokenResponse'
              examples:
                success:
                  value:
                    token: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4"
                    expires_in: 600
                    job_id: "770e8400-e29b-41d4-a716-446655440000"
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  value:
                    detail: "Job with ID '770e8400-e29b-41d4-a716-446655440000' not found"
                    error_code: "JOB_NOT_FOUND"
        '500':
          description: Token generation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/jobs/{job_id}/logs:
    get:
      tags:
        - Jobs
      summary: Retrieve historical logs for a crawl job
      description: |
        Get historical logs for a completed or running crawl job with pagination and filtering.

        This endpoint:
        1. Validates that the job exists
        2. Retrieves logs from the database with optional filters
        3. Supports pagination for large log volumes
        4. Returns logs in chronological order (oldest first)

        **Filtering options:**
        - `log_level`: Filter by specific log level (DEBUG, INFO, WARNING, ERROR, CRITICAL)
        - `start_time`: Only return logs after this timestamp
        - `end_time`: Only return logs before this timestamp
        - `search`: Search for text in log messages (case-insensitive)

        **Pagination:**
        - Use `limit` and `offset` for pagination
        - Default limit is 100, max is 1000
        - `total` field indicates total logs matching filters
      operationId: getJobLogs
      parameters:
        - name: job_id
          in: path
          required: true
          description: ID of the job to retrieve logs for
          schema:
            type: string
            format: uuid
            example: "770e8400-e29b-41d4-a716-446655440000"
        - name: log_level
          in: query
          required: false
          description: Filter by log level
          schema:
            $ref: '#/components/schemas/LogLevelEnum'
        - name: start_time
          in: query
          required: false
          description: Filter logs after this timestamp (ISO 8601)
          schema:
            type: string
            format: date-time
            example: "2025-10-29T00:00:00Z"
        - name: end_time
          in: query
          required: false
          description: Filter logs before this timestamp (ISO 8601)
          schema:
            type: string
            format: date-time
            example: "2025-10-29T23:59:59Z"
        - name: search
          in: query
          required: false
          description: Search text in log messages (case-insensitive)
          schema:
            type: string
            minLength: 1
            maxLength: 500
            example: "error connecting"
        - name: limit
          in: query
          required: false
          description: Number of logs to return (max 1000)
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
            example: 100
        - name: offset
          in: query
          required: false
          description: Number of logs to skip for pagination
          schema:
            type: integer
            minimum: 0
            default: 0
            example: 0
      responses:
        '200':
          description: Logs retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CrawlLogsResponse'
              examples:
                success:
                  value:
                    logs:
                      - id: 12345
                        job_id: "770e8400-e29b-41d4-a716-446655440000"
                        website_id: "550e8400-e29b-41d4-a716-446655440000"
                        step_name: "crawl_step_1"
                        log_level: "INFO"
                        message: "Starting crawl for URL: https://example.com"
                        context:
                          url: "https://example.com"
                        trace_id: null
                        created_at: "2025-10-29T10:00:00Z"
                      - id: 12346
                        job_id: "770e8400-e29b-41d4-a716-446655440000"
                        website_id: "550e8400-e29b-41d4-a716-446655440000"
                        step_name: "crawl_step_1"
                        log_level: "INFO"
                        message: "Successfully fetched page"
                        context:
                          url: "https://example.com"
                          status_code: 200
                        trace_id: null
                        created_at: "2025-10-29T10:00:05Z"
                    total: 150
                    limit: 100
                    offset: 0
                empty:
                  summary: No logs found
                  value:
                    logs: []
                    total: 0
                    limit: 100
                    offset: 0
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  value:
                    detail: "Job with ID '770e8400-e29b-41d4-a716-446655440000' not found"
                    error_code: "JOB_NOT_FOUND"
        '422':
          description: Validation error (invalid parameters)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================================================
  # Dead Letter Queue Endpoints
  # ============================================================================

  /api/v1/dlq/entries:
    get:
      tags:
        - Dead Letter Queue
      summary: List dead letter queue entries
      description: |
        List permanently failed jobs in the Dead Letter Queue with filtering and pagination.

        The DLQ contains jobs that have:
        - Exceeded maximum retry attempts
        - Failed with non-retryable errors (404, 401, validation errors)

        **Filtering options:**
        - `error_category`: Filter by error type
        - `website_id`: Filter by website
        - `unresolved_only`: Show only unresolved entries

        **Pagination:**
        - Use `limit` and `offset` for pagination
        - Default limit is 100, max is 500
      operationId: listDLQEntries
      parameters:
        - name: error_category
          in: query
          required: false
          description: Filter by error category
          schema:
            $ref: '#/components/schemas/ErrorCategoryEnum'
        - name: website_id
          in: query
          required: false
          description: Filter by website ID
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
        - name: unresolved_only
          in: query
          required: false
          description: Show only unresolved entries (true) or only resolved (false), or all (omit)
          schema:
            type: boolean
            example: true
        - name: limit
          in: query
          required: false
          description: Number of entries to return (max 500)
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 100
            example: 100
        - name: offset
          in: query
          required: false
          description: Number of entries to skip for pagination
          schema:
            type: integer
            minimum: 0
            default: 0
            example: 0
      responses:
        '200':
          description: DLQ entries retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DLQEntriesResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/dlq/entries/{dlq_id}:
    get:
      tags:
        - Dead Letter Queue
      summary: Get DLQ entry details
      description: |
        Retrieve detailed information about a specific Dead Letter Queue entry.

        Includes:
        - Job metadata (URL, website, type, priority)
        - Error details (category, message, stack trace, HTTP status)
        - Retry history (total attempts, timing)
        - Resolution status
      operationId: getDLQEntry
      parameters:
        - name: dlq_id
          in: path
          required: true
          description: DLQ entry ID
          schema:
            type: integer
            format: int64
            example: 12345
      responses:
        '200':
          description: DLQ entry retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DLQEntryResponse'
        '404':
          description: DLQ entry not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/dlq/entries/{dlq_id}/retry:
    post:
      tags:
        - Dead Letter Queue
      summary: Manually retry a DLQ entry
      description: |
        Attempt to manually retry a permanently failed job from the DLQ.

        This endpoint:
        1. Creates a new crawl job with the same configuration
        2. Marks the DLQ entry as retry attempted
        3. Returns the new job ID for tracking

        **Note:** The original DLQ entry is kept for audit purposes.
        The retry attempt status is tracked separately.
      operationId: retryDLQEntry
      parameters:
        - name: dlq_id
          in: path
          required: true
          description: DLQ entry ID to retry
          schema:
            type: integer
            format: int64
            example: 12345
      requestBody:
        description: No request body needed for retry operation
        required: false
        content:
          application/json:
            schema:
              type: object
              nullable: true
            examples:
              empty:
                summary: No body required
                value: null
      responses:
        '200':
          description: Retry initiated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DLQRetryResponse'
        '404':
          description: DLQ entry not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Entry already resolved or retry in progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/dlq/entries/{dlq_id}/resolve:
    post:
      tags:
        - Dead Letter Queue
      summary: Mark DLQ entry as resolved
      description: |
        Mark a DLQ entry as resolved without retrying.

        Use this when:
        - The issue has been fixed manually
        - The failure is expected and should be ignored
        - The job is no longer relevant

        Resolution notes are optional but recommended for audit purposes.
      operationId: resolveDLQEntry
      parameters:
        - name: dlq_id
          in: path
          required: true
          description: DLQ entry ID to resolve
          schema:
            type: integer
            format: int64
            example: 12345
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResolveDLQRequest'
            example:
              resolution_notes: "Issue fixed manually - database inconsistency resolved"
      responses:
        '200':
          description: DLQ entry resolved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DLQEntryResponse'
        '404':
          description: DLQ entry not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Entry already resolved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/dlq/stats:
    get:
      tags:
        - Dead Letter Queue
      summary: Get DLQ statistics
      description: |
        Retrieve overall statistics about the Dead Letter Queue.

        Includes:
        - Total entries
        - Unresolved entries
        - Retry attempts and successes
        - Statistics by error category
      operationId: getDLQStats
      responses:
        '200':
          description: Statistics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DLQStatsResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/duplicates/groups:
    get:
      tags:
        - Duplicates
      summary: List all duplicate groups
      description: |
        List all duplicate content groups with pagination.

        This endpoint:
        1. Returns all groups where content duplicates have been detected
        2. Supports pagination via limit/offset parameters
        3. Each group represents a cluster of duplicate pages

        **Use cases:**
        - Content audit dashboards showing duplicate statistics
        - Batch processing of duplicate groups
        - Monitoring content quality across crawled websites

        **Pagination:**
        - Default limit: 50 groups
        - Maximum limit: 100 groups
        - Use offset for page navigation
      operationId: listDuplicateGroups
      parameters:
        - name: limit
          in: query
          required: false
          description: Number of groups to return (1-100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: offset
          in: query
          required: false
          description: Number of groups to skip for pagination
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of duplicate groups retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DuplicateGroup'
        '400':
          description: Validation error (e.g., limit exceeds maximum)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/duplicates/groups/{group_id}:
    get:
      tags:
        - Duplicates
      summary: Get detailed information about a duplicate group
      description: |
        Retrieve complete details about a specific duplicate group.

        This endpoint:
        1. Returns the canonical (original) page information
        2. Lists all duplicate pages in the group with detection metadata
        3. Includes similarity scores and detection methods

        **Response includes:**
        - Canonical page URL, content hash, and crawl timestamp
        - Complete list of duplicate pages with:
          - Detection method (exact_hash, fuzzy_match, url_match, manual)
          - Similarity percentage (0-100)
          - Detection timestamp and source
          - Original crawl timestamp

        **Use cases:**
        - Investigating specific duplicate clusters
        - Manual review of automatic duplicate detection
        - Content deduplication workflows
      operationId: getDuplicateGroupDetails
      parameters:
        - name: group_id
          in: path
          required: true
          description: UUID of the duplicate group
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Group details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DuplicateGroupDetails'
        '404':
          description: Group not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/duplicates/groups/{group_id}/stats:
    get:
      tags:
        - Duplicates
      summary: Get statistics for a duplicate group
      description: |
        Retrieve aggregated statistics for a duplicate group.

        This endpoint:
        1. Returns group size and relationship counts
        2. Calculates average similarity across all duplicates
        3. Provides detection timestamps (first/last)

        **Statistics included:**
        - Group size (total pages including canonical)
        - Relationship count (number of duplicate links)
        - Average similarity score
        - First/last detection timestamps

        **Use cases:**
        - Duplicate detection quality analysis
        - Performance monitoring dashboards
        - Duplicate trend analysis over time
      operationId: getDuplicateGroupStats
      parameters:
        - name: group_id
          in: path
          required: true
          description: UUID of the duplicate group
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Statistics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DuplicateGroupStats'
        '404':
          description: Group not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    # ============================================================================
    # Base Schemas
    # ============================================================================

    RootResponse:
      type: object
      required:
        - message
        - version
        - environment
      properties:
        message:
          type: string
          description: Welcome message
          example: "Welcome to Lexicon Crawler"
        version:
          type: string
          description: Application version
          example: "1.0.0"
        environment:
          type: string
          description: Environment name
          enum: [development, staging, production, testing]
          example: "development"

    HealthResponse:
      type: object
      required:
        - status
        - timestamp
        - checks
      properties:
        status:
          type: string
          description: Overall health status
          enum: [healthy, unhealthy]
          example: "healthy"
        timestamp:
          type: string
          format: date-time
          description: Check timestamp (ISO 8601)
          example: "2025-10-27T10:00:00Z"
        checks:
          type: object
          description: Individual service checks
          additionalProperties:
            type: string
          example:
            database: "connected"
            redis: "connected"

    ErrorResponse:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          description: Error message
          example: "Invalid cron expression"
        error_code:
          type: string
          description: Machine-readable error code
          example: "INVALID_CRON_EXPRESSION"
        field:
          type: string
          description: Field that caused the error (for validation errors)
          example: "cron_schedule"

    ValidationError:
      type: object
      required:
        - detail
      properties:
        detail:
          type: array
          items:
            type: object
            properties:
              loc:
                type: array
                items:
                  type: string
                description: Location of the error
              msg:
                type: string
                description: Error message
              type:
                type: string
                description: Error type

    # ============================================================================
    # Enums
    # ============================================================================

    StatusEnum:
      type: string
      enum:
        - pending
        - running
        - completed
        - failed
        - cancelled
        - active
        - inactive
      description: Status of website or job

    ScheduleTypeEnum:
      type: string
      enum:
        - once
        - recurring
      description: Schedule type for website crawling

    StepTypeEnum:
      type: string
      enum:
        - crawl
        - scrape
      description: Type of crawl step

    MethodEnum:
      type: string
      enum:
        - api
        - browser
        - http
      description: Method used for crawling/scraping

    BrowserTypeEnum:
      type: string
      enum:
        - playwright
        - undetected_chromedriver
      description: Browser type for automation

    LogLevelEnum:
      type: string
      enum:
        - DEBUG
        - INFO
        - WARNING
        - ERROR
        - CRITICAL
      description: Log level for crawl logs

    ErrorCategoryEnum:
      type: string
      enum:
        - network_error
        - timeout
        - rate_limit
        - server_error
        - browser_crash
        - resource_unavailable
        - client_error
        - auth_error
        - not_found
        - validation_error
        - business_logic_error
        - unknown
      description: |
        Category of error for retry policy classification:
        - network_error: Connection failures, DNS errors
        - timeout: Request timeouts
        - rate_limit: HTTP 429 or rate limiting
        - server_error: HTTP 5xx errors
        - browser_crash: Browser process crashed
        - resource_unavailable: HTTP 503 Service Unavailable
        - client_error: HTTP 4xx errors (except 401, 404, 429)
        - auth_error: HTTP 401 Unauthorized
        - not_found: HTTP 404 Not Found
        - validation_error: Invalid configuration or parameters
        - business_logic_error: Application-level errors
        - unknown: Unclassified errors

    JobTypeEnum:
      type: string
      enum:
        - one_time
        - recurring
      description: |
        Type of crawl job:
        - one_time: Single execution job
        - recurring: Scheduled recurring job

    PaginationTypeEnum:
      type: string
      enum:
        - page_based
        - offset_based
        - cursor_based
        - next_button
        - url_pattern
      description: Pagination type

    ActionTypeEnum:
      type: string
      enum:
        - wait
        - click
        - fill
        - scroll
        - execute_script
        - hover
      description: Action type for browser automation

    SelectorTypeEnum:
      type: string
      enum:
        - single
        - array
      description: Type of selector result

    # ============================================================================
    # Configuration Schemas
    # ============================================================================

    ScheduleConfig:
      type: object
      properties:
        type:
          $ref: '#/components/schemas/ScheduleTypeEnum'
          default: recurring
        cron:
          type: string
          description: Cron expression (minute hour day month weekday)
          default: "0 0 1,15 * *"
          example: "0 0 1,15 * *"
          pattern: '^(\*|([0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9])|\*\/([0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9])) (\*|([0-9]|1[0-9]|2[0-3])|\*\/([0-9]|1[0-9]|2[0-3])) (\*|([1-9]|1[0-9]|2[0-9]|3[0-1])|\*\/([1-9]|1[0-9]|2[0-9]|3[0-1])) (\*|([1-9]|1[0-2])|\*\/([1-9]|1[0-2])) (\*|([0-6])|\*\/([0-6]))$'
        timezone:
          type: string
          description: Timezone for schedule
          default: "UTC"
          example: "UTC"
        enabled:
          type: boolean
          description: Enable/disable schedule
          default: true

    RateLimitConfig:
      type: object
      properties:
        requests_per_second:
          type: number
          format: float
          description: Max requests per second
          minimum: 0.1
          maximum: 100
          default: 2.0
        concurrent_pages:
          type: integer
          description: Max concurrent pages
          minimum: 1
          maximum: 50
          default: 5
        burst:
          type: integer
          description: Max burst requests
          minimum: 1
          maximum: 100
          default: 10

    TimeoutConfig:
      type: object
      properties:
        page_load:
          type: integer
          description: Page load timeout (seconds)
          minimum: 5
          maximum: 300
          default: 30
        selector_wait:
          type: integer
          description: Selector wait timeout (seconds)
          minimum: 1
          maximum: 60
          default: 10
        http_request:
          type: integer
          description: HTTP request timeout (seconds)
          minimum: 5
          maximum: 300
          default: 30

    RetryConfig:
      type: object
      properties:
        max_attempts:
          type: integer
          description: Maximum retry attempts
          minimum: 1
          maximum: 10
          default: 3
        backoff_strategy:
          type: string
          description: Backoff strategy
          enum: [exponential, linear, fixed]
          default: "exponential"
        backoff_base:
          type: number
          format: float
          description: Backoff base multiplier
          minimum: 1.0
          maximum: 10.0
          default: 2.0
        initial_delay:
          type: integer
          description: Initial delay (seconds)
          minimum: 1
          maximum: 60
          default: 1
        max_delay:
          type: integer
          description: Maximum delay (seconds)
          minimum: 1
          maximum: 3600
          default: 300

    GlobalConfig:
      type: object
      properties:
        rate_limit:
          $ref: '#/components/schemas/RateLimitConfig'
        timeout:
          $ref: '#/components/schemas/TimeoutConfig'
        retry:
          $ref: '#/components/schemas/RetryConfig'
        headers:
          type: object
          description: Global HTTP headers
          additionalProperties:
            type: string
          example:
            User-Agent: "Mozilla/5.0"
            Accept: "text/html"
        cookies:
          type: object
          description: Global cookies
          additionalProperties:
            type: string
      additionalProperties: true

    # ============================================================================
    # Step Configuration Schemas
    # ============================================================================

    PaginationConfig:
      type: object
      properties:
        enabled:
          type: boolean
          description: Enable pagination
          default: false
        type:
          $ref: '#/components/schemas/PaginationTypeEnum'
          default: "page_based"
        page_param:
          type: string
          description: Page parameter name
          default: "page"
        start_page:
          type: integer
          description: Starting page number
          minimum: 1
          default: 1
        max_pages:
          type: integer
          description: Maximum pages to crawl
          minimum: 1
          maximum: 1000
          default: 100
        selector:
          type: string
          description: Next button selector (for browser)
          nullable: true
        wait_after_click:
          type: integer
          description: Wait time after clicking next (ms)
          minimum: 0
          default: 2000
          nullable: true
        url_template:
          type: string
          description: URL template with {page} placeholder
          nullable: true
          example: "https://example.com/page/{page}"
        min_content_length:
          type: integer
          description: Minimum content length to consider page non-empty (bytes)
          minimum: 0
          default: 100
        max_empty_responses:
          type: integer
          description: Maximum consecutive empty responses before stopping pagination
          minimum: 1
          maximum: 10
          default: 2
        track_content_hashes:
          type: boolean
          description: Enable duplicate content detection via hashing
          default: true
        track_urls:
          type: boolean
          description: Enable circular pagination detection (URL revisit tracking)
          default: true

    ActionConfig:
      type: object
      required:
        - type
      properties:
        type:
          $ref: '#/components/schemas/ActionTypeEnum'
        selector:
          type: string
          description: Element selector
          nullable: true
        value:
          type: string
          description: Value for fill actions or wait duration
          nullable: true
        timeout:
          type: integer
          description: Action timeout (ms)
          minimum: 0
          maximum: 60000
          default: 5000
        optional:
          type: boolean
          description: Continue if action fails
          default: false

    StepConfig:
      type: object
      properties:
        url:
          type: string
          description: URL to fetch (supports variables like {base_url})
          nullable: true
          example: "https://example.com/api/data"
        http_method:
          type: string
          description: HTTP method
          enum: [GET, POST, PUT, DELETE, PATCH]
          default: "GET"
        headers:
          type: object
          description: HTTP headers
          additionalProperties:
            type: string
        query_params:
          type: object
          description: Query parameters
          additionalProperties: true
        pagination:
          $ref: '#/components/schemas/PaginationConfig'
          nullable: true
        wait_until:
          type: string
          description: Browser wait condition
          enum: [load, domcontentloaded, networkidle]
          default: "networkidle"
          nullable: true
        actions:
          type: array
          description: Browser actions
          items:
            $ref: '#/components/schemas/ActionConfig'
        timeout:
          type: integer
          description: Request timeout (seconds)
          minimum: 1
          maximum: 300
          default: 30
      additionalProperties: true

    OutputConfig:
      type: object
      properties:
        urls_field:
          type: string
          description: Field name for extracted URLs
          default: "detail_urls"
          nullable: true
        main_content_field:
          type: string
          description: Main content field name
          default: "content"
          nullable: true
        metadata_fields:
          type: array
          description: Metadata fields to extract
          items:
            type: string
          default: []

    SelectorConfig:
      type: object
      required:
        - selector
      properties:
        selector:
          type: string
          description: CSS selector or XPath expression
          example: ".article-title"
        attribute:
          type: string
          description: Attribute to extract (text, html, href, src, etc.)
          default: "text"
          example: "text"
          nullable: true
        type:
          $ref: '#/components/schemas/SelectorTypeEnum'
          default: "single"

    SelectorValue:
      oneOf:
        - type: string
          description: Simple CSS selector string
        - $ref: '#/components/schemas/SelectorConfig'
      description: Selector value can be either a simple string or a detailed selector configuration

    CrawlStep:
      type: object
      required:
        - name
        - type
        - method
      properties:
        name:
          type: string
          description: Unique step name
          minLength: 1
          maxLength: 255
          example: "crawl_list"
        type:
          $ref: '#/components/schemas/StepTypeEnum'
        description:
          type: string
          description: Human-readable description
          nullable: true
          example: "Crawl article list page"
        method:
          $ref: '#/components/schemas/MethodEnum'
        browser_type:
          $ref: '#/components/schemas/BrowserTypeEnum'
          nullable: true
        input_from:
          type: string
          description: Input data source from previous step (e.g., 'crawl_list.detail_urls')
          nullable: true
          example: "crawl_list.detail_urls"
        config:
          $ref: '#/components/schemas/StepConfig'
        selectors:
          type: object
          description: CSS/XPath selectors for data extraction
          additionalProperties:
            $ref: '#/components/schemas/SelectorValue'
          example:
            title: "h1.title"
            content: ".article-body"
            links:
              selector: "a.article-link"
              attribute: "href"
              type: "array"
        output:
          $ref: '#/components/schemas/OutputConfig'

    # ============================================================================
    # Request/Response Schemas
    # ============================================================================

    CreateWebsiteRequest:
      type: object
      required:
        - name
        - base_url
        - steps
      properties:
        name:
          type: string
          description: Unique website name
          minLength: 1
          maxLength: 255
          example: "Example News Site"
        base_url:
          type: string
          description: Base URL of the website
          minLength: 1
          maxLength: 2048
          format: uri
          example: "https://example.com"
        description:
          type: string
          description: Optional description
          nullable: true
          example: "News site crawler for daily articles"
        schedule:
          $ref: '#/components/schemas/ScheduleConfig'
        steps:
          type: array
          description: List of crawl/scrape steps to execute
          minItems: 1
          items:
            $ref: '#/components/schemas/CrawlStep'
        global_config:
          $ref: '#/components/schemas/GlobalConfig'
        variables:
          type: object
          description: Variables for substitution in URLs and configurations
          additionalProperties: true
          example:
            api_key: "YOUR_API_KEY"
            user_id: "12345"

    WebsiteResponse:
      type: object
      required:
        - id
        - name
        - base_url
        - config
        - status
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Website ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          description: Website name
          example: "Example News Site"
        base_url:
          type: string
          format: uri
          description: Base URL
          example: "https://example.com"
        config:
          type: object
          description: Full configuration
          additionalProperties: true
        status:
          $ref: '#/components/schemas/StatusEnum'
        cron_schedule:
          type: string
          description: Cron schedule expression
          nullable: true
          example: "0 0 1,15 * *"
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
          example: "2025-10-27T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp
          example: "2025-10-27T10:00:00Z"
        created_by:
          type: string
          description: Creator identifier
          nullable: true
          example: "user@example.com"
        next_run_time:
          type: string
          format: date-time
          description: Next scheduled crawl time (if scheduled job exists)
          nullable: true
          example: "2025-11-01T00:00:00Z"
        scheduled_job_id:
          type: string
          format: uuid
          description: Associated scheduled job ID
          nullable: true
          example: "660e8400-e29b-41d4-a716-446655440000"

    UpdateWebsiteRequest:
      type: object
      properties:
        name:
          type: string
          description: Updated website name
          minLength: 1
          maxLength: 255
          nullable: true
          example: "Updated News Site"
        steps:
          type: array
          description: Updated list of crawl/scrape steps
          items:
            $ref: '#/components/schemas/CrawlStep'
          minItems: 1
          nullable: true
        variables:
          type: object
          description: Updated variables for substitution
          additionalProperties: true
          nullable: true
        global_config:
          $ref: '#/components/schemas/GlobalConfig'
          nullable: true
        schedule:
          $ref: '#/components/schemas/ScheduleConfig'
          nullable: true
        status:
          $ref: '#/components/schemas/StatusEnum'
          nullable: true
        change_reason:
          type: string
          description: Reason for this configuration change (for audit trail)
          maxLength: 1000
          nullable: true
          example: "Updated API endpoint to v2"
        trigger_recrawl:
          type: boolean
          description: If true, immediately trigger a new crawl job with updated config
          default: false
          example: false

    UpdateWebsiteResponse:
      allOf:
        - $ref: '#/components/schemas/WebsiteResponse'
        - $ref: '#/components/schemas/UpdateWebsiteResponseExtension'

    UpdateWebsiteResponseExtension:
      type: object
      required:
        - config_version
      properties:
        config_version:
          type: integer
          description: Current configuration version number after update
          minimum: 1
          example: 3
        recrawl_job_id:
          type: string
          format: uuid
          description: ID of the triggered crawl job (if trigger_recrawl was true)
          nullable: true
          example: "770e8400-e29b-41d4-a716-446655440000"

    WebsiteStatistics:
      type: object
      required:
        - total_jobs
        - completed_jobs
        - failed_jobs
        - cancelled_jobs
        - success_rate
        - total_pages_crawled
      properties:
        total_jobs:
          type: integer
          description: Total number of crawl jobs for this website
          minimum: 0
          example: 15
        completed_jobs:
          type: integer
          description: Number of successfully completed jobs
          minimum: 0
          example: 12
        failed_jobs:
          type: integer
          description: Number of failed jobs
          minimum: 0
          example: 2
        cancelled_jobs:
          type: integer
          description: Number of cancelled jobs
          minimum: 0
          example: 1
        success_rate:
          type: number
          format: float
          description: Success rate as percentage (completed / total * 100)
          minimum: 0
          maximum: 100
          example: 80.0
        total_pages_crawled:
          type: integer
          description: Total pages crawled across all jobs
          minimum: 0
          example: 1250
        last_crawl_at:
          type: string
          format: date-time
          description: Timestamp of last successful crawl
          nullable: true
          example: "2025-10-30T10:30:00Z"

    WebsiteWithStatsResponse:
      allOf:
        - $ref: '#/components/schemas/WebsiteResponse'
        - $ref: '#/components/schemas/WebsiteWithStatsResponseExtension'

    WebsiteWithStatsResponseExtension:
      type: object
      required:
        - statistics
      properties:
        statistics:
          $ref: '#/components/schemas/WebsiteStatistics'

    WebsiteSummary:
      type: object
      required:
        - id
        - name
        - base_url
        - status
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Website ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          description: Website name
          example: "Example News Site"
        base_url:
          type: string
          format: uri
          description: Base URL
          example: "https://example.com"
        status:
          $ref: '#/components/schemas/StatusEnum'
        cron_schedule:
          type: string
          description: Cron schedule expression
          nullable: true
          example: "0 0 1,15 * *"
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
          example: "2025-10-27T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp
          example: "2025-10-27T10:00:00Z"

    ListWebsitesResponse:
      type: object
      required:
        - websites
        - total
        - limit
        - offset
      properties:
        websites:
          type: array
          description: List of websites
          items:
            $ref: '#/components/schemas/WebsiteSummary'
        total:
          type: integer
          description: Total number of websites matching the filters
          minimum: 0
          example: 2
        limit:
          type: integer
          description: Number of websites per page
          minimum: 1
          maximum: 100
          example: 20
        offset:
          type: integer
          description: Number of websites skipped
          minimum: 0
          example: 0

    CreateSeedJobRequest:
      type: object
      required:
        - website_id
        - seed_url
      properties:
        website_id:
          type: string
          format: uuid
          description: ID of the website template to use for configuration
          example: "550e8400-e29b-41d4-a716-446655440000"
        seed_url:
          type: string
          description: Starting URL for the crawl job
          minLength: 1
          maxLength: 2048
          format: uri
          example: "https://example.com/articles/2025/technology"
        variables:
          type: object
          description: Variables for substitution in URLs and configurations (overrides template variables)
          additionalProperties: true
          example:
            category: "technology"
            year: "2025"
            api_key: "YOUR_API_KEY"
        priority:
          type: integer
          description: Job priority (1=lowest, 10=highest)
          minimum: 1
          maximum: 10
          default: 5

    SeedJobResponse:
      type: object
      required:
        - id
        - seed_url
        - status
        - job_type
        - priority
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Crawl job ID
          example: "770e8400-e29b-41d4-a716-446655440000"
        website_id:
          type: string
          format: uuid
          description: Website template ID (null for inline config jobs)
          nullable: true
          example: "550e8400-e29b-41d4-a716-446655440000"
        seed_url:
          type: string
          format: uri
          description: Starting URL for crawl
          example: "https://example.com/articles/2025/technology"
        status:
          $ref: '#/components/schemas/StatusEnum'
        job_type:
          type: string
          enum: [one_time, scheduled, recurring]
          description: Job type
          example: "one_time"
        priority:
          type: integer
          description: Job priority
          example: 5
        scheduled_at:
          type: string
          format: date-time
          description: Scheduled execution time
          nullable: true
          example: null
        variables:
          type: object
          description: Variables used for this job
          additionalProperties: true
          nullable: true
          example:
            category: "technology"
            year: "2025"
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
          example: "2025-10-29T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp
          example: "2025-10-29T10:00:00Z"

    CreateSeedJobInlineRequest:
      type: object
      required:
        - seed_url
        - steps
      properties:
        seed_url:
          type: string
          description: Starting URL for the crawl job
          minLength: 1
          maxLength: 2048
          format: uri
          example: "https://example.com/articles"
        steps:
          type: array
          description: List of crawl/scrape steps to execute
          minItems: 1
          items:
            $ref: '#/components/schemas/CrawlStep'
        global_config:
          $ref: '#/components/schemas/GlobalConfig'
        variables:
          type: object
          description: Variables for substitution in URLs and configurations
          additionalProperties: true
          example:
            api_key: "YOUR_API_KEY"
            category: "technology"
        priority:
          type: integer
          description: Job priority (1=lowest, 10=highest)
          minimum: 1
          maximum: 10
          default: 5

    CancelJobRequest:
      type: object
      properties:
        reason:
          type: string
          description: Optional reason for cancellation
          maxLength: 500
          nullable: true
          example: "User requested cancellation"

    CancelJobResponse:
      type: object
      required:
        - id
        - status
        - message
        - cancelled_at
      properties:
        id:
          type: string
          format: uuid
          description: Job ID
          example: "770e8400-e29b-41d4-a716-446655440000"
        status:
          $ref: '#/components/schemas/StatusEnum'
        message:
          type: string
          description: Success message
          example: "Job cancellation initiated"
        cancelled_at:
          type: string
          format: date-time
          description: Cancellation timestamp
          example: "2025-10-29T10:30:00Z"

    WSTokenResponse:
      type: object
      required:
        - token
        - expires_in
        - job_id
      properties:
        token:
          type: string
          description: WebSocket authentication token (secure random string)
          minLength: 20
          example: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4"
        expires_in:
          type: integer
          description: Token expiration time in seconds
          example: 600
        job_id:
          type: string
          format: uuid
          description: Job ID this token is valid for
          example: "770e8400-e29b-41d4-a716-446655440000"

    CrawlLogEntry:
      type: object
      required:
        - id
        - job_id
        - website_id
        - log_level
        - message
        - created_at
      properties:
        id:
          type: integer
          format: int64
          description: Log entry ID
          example: 12345
        job_id:
          type: string
          format: uuid
          description: Job ID
          example: "770e8400-e29b-41d4-a716-446655440000"
        website_id:
          type: string
          format: uuid
          description: Website ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        step_name:
          type: string
          description: Step name that generated the log
          nullable: true
          example: "crawl_step_1"
        log_level:
          $ref: '#/components/schemas/LogLevelEnum'
        message:
          type: string
          description: Log message
          example: "Successfully fetched page: https://example.com"
        context:
          type: object
          description: Additional context data (JSON)
          nullable: true
          additionalProperties: true
          example:
            url: "https://example.com"
            status_code: 200
        trace_id:
          type: string
          format: uuid
          description: Trace ID for distributed tracing
          nullable: true
          example: "a1b2c3d4-e5f6-47h8-i9j0-k1l2m3n4o5p6"
        created_at:
          type: string
          format: date-time
          description: Log creation timestamp
          example: "2025-10-29T10:30:15Z"

    CrawlLogsResponse:
      type: object
      required:
        - logs
        - total
        - limit
        - offset
      properties:
        logs:
          type: array
          description: List of log entries
          items:
            $ref: '#/components/schemas/CrawlLogEntry'
        total:
          type: integer
          description: Total number of logs matching the filters
          example: 150
        limit:
          type: integer
          description: Number of logs per page
          example: 100
        offset:
          type: integer
          description: Offset for pagination
          example: 0

    ConfigHistoryResponse:
      type: object
      required:
        - id
        - website_id
        - version
        - config
        - created_at
      properties:
        id:
          type: string
          format: uuid
          description: History entry ID
          example: "880e8400-e29b-41d4-a716-446655440000"
        website_id:
          type: string
          format: uuid
          description: Website ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        version:
          type: integer
          minimum: 1
          description: Version number
          example: 3
        config:
          type: object
          description: Full configuration snapshot at this version
          additionalProperties: true
        changed_by:
          type: string
          nullable: true
          description: User or system that made the change
          example: "admin"
        change_reason:
          type: string
          nullable: true
          description: Reason for the configuration change
          example: "Updated rate limits for better performance"
        created_at:
          type: string
          format: date-time
          description: When this version was created
          example: "2025-11-09T12:00:00Z"

    ConfigHistoryListResponse:
      type: object
      required:
        - versions
        - total
        - limit
        - offset
      properties:
        versions:
          type: array
          description: List of configuration versions
          items:
            $ref: '#/components/schemas/ConfigHistoryResponse'
        total:
          type: integer
          description: Total number of versions for this website
          example: 15
        limit:
          type: integer
          description: Number of versions per page
          example: 10
        offset:
          type: integer
          description: Offset for pagination
          example: 0

    RollbackConfigRequest:
      type: object
      required:
        - version
      properties:
        version:
          type: integer
          minimum: 1
          description: Target version number to rollback to
          example: 2
        rollback_reason:
          type: string
          description: Reason for rolling back the configuration
          nullable: true
          example: "Reverting to stable configuration due to crawl failures"
        trigger_recrawl:
          type: boolean
          default: false
          description: Whether to trigger an immediate re-crawl after rollback
          example: false

    RollbackConfigResponse:
      type: object
      required:
        - id
        - name
        - base_url
        - config
        - status
        - created_at
        - updated_at
        - config_version
        - rolled_back_from_version
        - rolled_back_to_version
      properties:
        id:
          type: string
          format: uuid
          description: Website ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          description: Website name
          example: "Example News Site"
        base_url:
          type: string
          format: uri
          description: Base URL of the website
          example: "https://news.example.com"
        config:
          type: object
          description: Restored configuration (from target version)
          additionalProperties: true
        status:
          $ref: '#/components/schemas/StatusEnum'
        cron_schedule:
          type: string
          nullable: true
          description: Default cron schedule
          example: "0 0 1,15 * *"
        created_at:
          type: string
          format: date-time
          description: Website creation timestamp
          example: "2025-10-27T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp
          example: "2025-11-09T14:00:00Z"
        created_by:
          type: string
          nullable: true
          description: User who created the website
          example: null
        next_run_time:
          type: string
          format: date-time
          nullable: true
          description: Next scheduled run time
          example: "2025-11-15T00:00:00Z"
        scheduled_job_id:
          type: string
          format: uuid
          nullable: true
          description: Associated scheduled job ID
          example: "660e8400-e29b-41d4-a716-446655440000"
        config_version:
          type: integer
          description: New version number created by the rollback
          example: 5
        rolled_back_from_version:
          type: integer
          description: Version that was active before rollback
          example: 4
        rolled_back_to_version:
          type: integer
          description: Target version that was restored
          example: 2
        recrawl_job_id:
          type: string
          format: uuid
          nullable: true
          description: ID of re-crawl job if triggered
          example: null

    DeleteWebsiteResponse:
      type: object
      required:
        - id
        - name
        - deleted_at
        - cancelled_jobs
        - cancelled_job_ids
        - config_archived_version
        - message
      properties:
        id:
          type: string
          format: uuid
          description: Website ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          description: Website name
          example: "Example Website"
        deleted_at:
          type: string
          format: date-time
          description: Timestamp when website was deleted
          example: "2025-11-09T12:00:00Z"
        cancelled_jobs:
          type: integer
          description: Number of jobs cancelled
          minimum: 0
          example: 2
        cancelled_job_ids:
          type: array
          description: List of cancelled job IDs
          items:
            type: string
            format: uuid
          example:
            - "660e8400-e29b-41d4-a716-446655440000"
            - "770e8400-e29b-41d4-a716-446655440000"
        config_archived_version:
          type: integer
          description: Version number of archived configuration
          minimum: 1
          example: 5
        message:
          type: string
          description: Success message
          example: "Website 'Example Website' deleted successfully"

    DuplicateGroup:
      type: object
      required:
        - id
        - canonical_page_id
        - group_size
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Unique group identifier
          example: "990e8400-e29b-41d4-a716-446655440000"
        canonical_page_id:
          type: string
          format: uuid
          description: UUID of the canonical (original) page
          example: "770e8400-e29b-41d4-a716-446655440000"
        group_size:
          type: integer
          minimum: 1
          description: Total number of pages in group (including canonical)
          example: 5
        created_at:
          type: string
          format: date-time
          description: When the group was created
          example: "2025-10-29T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: When the group was last updated
          example: "2025-10-29T10:05:00Z"

    DuplicatePageInfo:
      type: object
      required:
        - id
        - duplicate_page_id
        - url
        - content_hash
        - detection_method
        - detected_at
        - crawled_at
      properties:
        id:
          type: integer
          description: Relationship ID
          example: 123
        duplicate_page_id:
          type: string
          format: uuid
          description: UUID of the duplicate page
          example: "880e8400-e29b-41d4-a716-446655440000"
        url:
          type: string
          format: uri
          description: Page URL
          example: "https://example.com/article-copy"
        content_hash:
          type: string
          description: Content hash of the page
          example: "content_hash_abc"
        detection_method:
          type: string
          enum: [exact_hash, fuzzy_match, url_match, manual]
          description: How the duplicate was detected
          example: "fuzzy_match"
        similarity_score:
          type: integer
          nullable: true
          minimum: 0
          maximum: 100
          description: Similarity percentage (0-100)
          example: 95
        confidence_threshold:
          type: integer
          nullable: true
          description: Detection confidence threshold
          example: 3
        detected_at:
          type: string
          format: date-time
          description: When the duplicate was detected
          example: "2025-10-29T10:02:00Z"
        detected_by:
          type: string
          nullable: true
          description: System/user that detected the duplicate
          example: "simhash_detector"
        crawled_at:
          type: string
          format: date-time
          description: When the page was originally crawled
          example: "2025-10-29T09:50:00Z"

    DuplicateGroupDetails:
      type: object
      required:
        - id
        - canonical_page_id
        - canonical_url
        - canonical_content_hash
        - canonical_crawled_at
        - group_size
        - created_at
        - updated_at
        - duplicates
      properties:
        id:
          type: string
          format: uuid
          description: Group ID
          example: "990e8400-e29b-41d4-a716-446655440000"
        canonical_page_id:
          type: string
          format: uuid
          description: UUID of the canonical page
          example: "770e8400-e29b-41d4-a716-446655440000"
        canonical_url:
          type: string
          format: uri
          description: URL of the canonical page
          example: "https://example.com/original-article"
        canonical_content_hash:
          type: string
          description: Content hash of the canonical page
          example: "content_hash_original"
        canonical_crawled_at:
          type: string
          format: date-time
          description: When canonical page was crawled
          example: "2025-10-29T09:45:00Z"
        group_size:
          type: integer
          minimum: 1
          description: Total number of pages in group
          example: 5
        created_at:
          type: string
          format: date-time
          description: When the group was created
          example: "2025-10-29T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: When the group was last updated
          example: "2025-10-29T10:05:00Z"
        duplicates:
          type: array
          description: List of duplicate pages in this group
          items:
            $ref: '#/components/schemas/DuplicatePageInfo'

    DuplicateGroupStats:
      type: object
      required:
        - id
        - canonical_page_id
        - group_size
        - relationship_count
      properties:
        id:
          type: string
          format: uuid
          description: Group ID
          example: "990e8400-e29b-41d4-a716-446655440000"
        canonical_page_id:
          type: string
          format: uuid
          description: UUID of the canonical page
          example: "770e8400-e29b-41d4-a716-446655440000"
        group_size:
          type: integer
          minimum: 1
          description: Total number of pages in group
          example: 5
        relationship_count:
          type: integer
          minimum: 0
          description: Number of duplicate relationships
          example: 4
        avg_similarity:
          type: number
          format: float
          nullable: true
          description: Average similarity score across all duplicates
          example: 92.5
        first_detected:
          type: string
          format: date-time
          nullable: true
          description: When first duplicate was detected
          example: "2025-10-29T10:00:00Z"
        last_detected:
          type: string
          format: date-time
          nullable: true
          description: When last duplicate was detected
          example: "2025-10-29T10:05:00Z"

    # ============================================================================
    # Dead Letter Queue Schemas
    # ============================================================================

    DLQEntry:
      type: object
      required:
        - id
        - job_id
        - seed_url
        - job_type
        - priority
        - error_category
        - error_message
        - total_attempts
        - first_attempt_at
        - last_attempt_at
        - added_to_dlq_at
        - retry_attempted
      properties:
        id:
          type: integer
          format: int64
          description: DLQ entry ID
          example: 12345
        job_id:
          type: string
          format: uuid
          description: Failed job UUID
          example: "770e8400-e29b-41d4-a716-446655440000"
        seed_url:
          type: string
          format: uri
          description: URL that was being crawled
          example: "https://example.com/page"
        website_id:
          type: string
          format: uuid
          nullable: true
          description: Website UUID (if job was part of website crawl)
          example: "550e8400-e29b-41d4-a716-446655440000"
        job_type:
          $ref: '#/components/schemas/JobTypeEnum'
        priority:
          type: integer
          minimum: 1
          maximum: 10
          description: Job priority (1=lowest, 10=highest)
          example: 5
        error_category:
          $ref: '#/components/schemas/ErrorCategoryEnum'
        error_message:
          type: string
          description: Error message
          example: "HTTP 404: Page not found"
        stack_trace:
          type: string
          nullable: true
          description: Stack trace (if available)
          example: "Traceback (most recent call last):\n  File..."
        http_status:
          type: integer
          nullable: true
          minimum: 100
          maximum: 599
          description: HTTP status code (if applicable)
          example: 404
        total_attempts:
          type: integer
          minimum: 1
          description: Total number of retry attempts before failure
          example: 3
        first_attempt_at:
          type: string
          format: date-time
          description: Timestamp of first attempt
          example: "2025-10-29T10:00:00Z"
        last_attempt_at:
          type: string
          format: date-time
          description: Timestamp of last attempt
          example: "2025-10-29T10:05:00Z"
        added_to_dlq_at:
          type: string
          format: date-time
          description: When job was added to DLQ
          example: "2025-10-29T10:05:00Z"
        retry_attempted:
          type: boolean
          description: Whether manual retry was attempted
          example: false
        retry_attempted_at:
          type: string
          format: date-time
          nullable: true
          description: When manual retry was attempted
          example: null
        retry_success:
          type: boolean
          nullable: true
          description: Whether manual retry succeeded
          example: null
        resolved_at:
          type: string
          format: date-time
          nullable: true
          description: When entry was marked as resolved
          example: null
        resolution_notes:
          type: string
          nullable: true
          description: Notes about resolution
          example: null

    DLQEntryResponse:
      type: object
      required:
        - entry
      properties:
        entry:
          $ref: '#/components/schemas/DLQEntry'

    DLQEntriesResponse:
      type: object
      required:
        - entries
        - total
        - limit
        - offset
      properties:
        entries:
          type: array
          items:
            $ref: '#/components/schemas/DLQEntry'
          description: List of DLQ entries
        total:
          type: integer
          minimum: 0
          description: Total number of entries matching filters
          example: 42
        limit:
          type: integer
          minimum: 1
          description: Number of entries per page
          example: 100
        offset:
          type: integer
          minimum: 0
          description: Number of entries skipped
          example: 0

    ResolveDLQRequest:
      type: object
      properties:
        resolution_notes:
          type: string
          minLength: 1
          maxLength: 1000
          description: Notes explaining the resolution
          example: "Fixed website configuration to handle this case"

    DLQRetryResponse:
      type: object
      required:
        - job_id
        - dlq_entry_id
        - message
      properties:
        job_id:
          type: string
          format: uuid
          description: New job UUID created for retry
          example: "880e8400-e29b-41d4-a716-446655440000"
        dlq_entry_id:
          type: integer
          format: int64
          description: DLQ entry ID that was retried
          example: 12345
        message:
          type: string
          description: Status message
          example: "Job retry initiated successfully"

    DLQCategoryStats:
      type: object
      required:
        - error_category
        - total
        - unresolved
      properties:
        error_category:
          $ref: '#/components/schemas/ErrorCategoryEnum'
        total:
          type: integer
          minimum: 0
          description: Total entries in this category
          example: 15
        unresolved:
          type: integer
          minimum: 0
          description: Unresolved entries in this category
          example: 8

    DLQStatsResponse:
      type: object
      required:
        - total_entries
        - unresolved_entries
        - retry_attempts
        - retry_successes
        - by_category
      properties:
        total_entries:
          type: integer
          minimum: 0
          description: Total DLQ entries
          example: 42
        unresolved_entries:
          type: integer
          minimum: 0
          description: Entries not yet resolved
          example: 25
        retry_attempts:
          type: integer
          minimum: 0
          description: Manual retry attempts
          example: 10
        retry_successes:
          type: integer
          minimum: 0
          description: Successful manual retries
          example: 7
        by_category:
          type: array
          items:
            $ref: '#/components/schemas/DLQCategoryStats'
          description: Statistics grouped by error category

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT Bearer token authentication (future implementation)

security: []

# Code generation hints
x-codegen-settings:
  packageName: lexicon-crawler-client
  packageVersion: 1.0.0
  generateModels: true
  generateApis: true
