openapi: 3.1.0
info:
  title: Lexicon Crawler API
  description: |
    Lexicon Crawler is a production-ready web crawler built with FastAPI and modern Python async patterns.
    It combines browser automation (Playwright, undetected-chromedriver) with distributed task queuing (NATS JetStream),
    persistent storage (PostgreSQL + GCS), and full observability (Prometheus, Grafana, Loki).

    ## Features
    - Website configuration with multi-step crawl/scrape workflows
    - Scheduled crawling with cron expressions
    - Browser automation (Playwright, undetected-chromedriver)
    - Rate limiting and retry logic
    - Full observability (metrics, structured logging)

  version: 1.0.0
  contact:
    name: Lexicon Crawler Support
    url: https://github.com/lexicon/crawler
  license:
    name: MIT
    identifier: MIT

servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://crawler.lexicon.id
    description: Production server

tags:
  - name: General
    description: General application endpoints (health, root, metrics)
  - name: Websites
    description: Website configuration and management
  - name: Jobs
    description: Crawl job creation and management
  - name: Monitoring
    description: Monitoring and observability endpoints

paths:
  /:
    get:
      tags:
        - General
      summary: Root endpoint
      description: Returns basic application information including name, version, and environment
      operationId: getRoot
      responses:
        '200':
          description: Application information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RootResponse'
              examples:
                default:
                  value:
                    message: "Welcome to Lexicon Crawler"
                    version: "1.0.0"
                    environment: "development"

  /health:
    get:
      tags:
        - General
      summary: Health check
      description: Check the health status of the application including database and Redis
      operationId: healthCheck
      responses:
        '200':
          description: Health check results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                healthy:
                  value:
                    status: "healthy"
                    timestamp: "2025-10-27T10:00:00Z"
                    checks:
                      database: "connected"
                      redis: "connected"
                unhealthy:
                  value:
                    status: "unhealthy"
                    timestamp: "2025-10-27T10:00:00Z"
                    checks:
                      database: "error: connection timeout"
                      redis: "connected"

  /metrics:
    get:
      tags:
        - Monitoring
      summary: Prometheus metrics
      description: Expose Prometheus metrics for monitoring
      operationId: getMetrics
      responses:
        '200':
          description: Prometheus metrics in text format
          content:
            text/plain:
              schema:
                type: string
                example: |
                  # HELP http_requests_total Total HTTP requests
                  # TYPE http_requests_total counter
                  http_requests_total{method="GET",endpoint="/"} 42

  /api/v1/websites:
    post:
      tags:
        - Websites
      summary: Create a new website configuration
      description: |
        Create a new website with crawl configuration and schedule.

        This endpoint:
        1. Validates the website configuration including selectors and steps
        2. Validates the cron schedule expression
        3. Stores the configuration in PostgreSQL
        4. Creates a scheduled job if schedule is enabled
        5. Returns the created website with ID and next run time

        The configuration includes:
        - Steps for crawling/scraping (API, Browser, or HTTP methods)
        - Selectors for data extraction
        - Schedule configuration with cron expression
        - Global settings (rate limits, timeouts, retries)
        - Variables for dynamic value substitution
      operationId: createWebsite
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWebsiteRequest'
            examples:
              simple_crawl:
                summary: Simple HTTP crawl
                value:
                  name: "Example News Site"
                  base_url: "https://news.example.com"
                  description: "Crawl news articles from example site"
                  schedule:
                    type: "recurring"
                    cron: "0 0 1,15 * *"
                    timezone: "UTC"
                    enabled: true
                  steps:
                    - name: "crawl_list"
                      type: "crawl"
                      description: "Get article list"
                      method: "http"
                      config:
                        url: "https://news.example.com/articles"
                      selectors:
                        detail_urls: ".article-link"
                      output:
                        urls_field: "detail_urls"
                    - name: "scrape_detail"
                      type: "scrape"
                      description: "Scrape article content"
                      method: "http"
                      input_from: "crawl_list.detail_urls"
                      selectors:
                        title: "h1.title"
                        content: ".article-body"
                        author: ".author-name"
                      output:
                        main_content_field: "content"
                  global_config:
                    rate_limit:
                      requests_per_second: 2.0
                      concurrent_pages: 5
                      burst: 10
                    timeout:
                      page_load: 30
                      selector_wait: 10
                      http_request: 30
                    retry:
                      max_attempts: 3
                      backoff_strategy: "exponential"
                      initial_delay: 1
              browser_crawl:
                summary: Browser-based crawl with Playwright
                value:
                  name: "Dynamic Content Site"
                  base_url: "https://dynamic.example.com"
                  schedule:
                    type: "recurring"
                    cron: "0 2 * * 1"
                    enabled: true
                  steps:
                    - name: "crawl_spa"
                      type: "crawl"
                      method: "browser"
                      browser_type: "playwright"
                      config:
                        url: "https://dynamic.example.com/products"
                        wait_until: "networkidle"
                        actions:
                          - type: "wait"
                            selector: ".product-list"
                            timeout: 5000
                          - type: "scroll"
                            value: "bottom"
                          - type: "wait"
                            value: "2000"
                      selectors:
                        product_urls: ".product-card a"
                      output:
                        urls_field: "product_urls"
                  global_config:
                    rate_limit:
                      requests_per_second: 1.0
                      concurrent_pages: 3
      responses:
        '201':
          description: Website created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebsiteResponse'
              examples:
                created:
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    name: "Example News Site"
                    base_url: "https://news.example.com"
                    config:
                      steps:
                        - name: "crawl_list"
                          type: "crawl"
                          method: "http"
                      global_config:
                        rate_limit:
                          requests_per_second: 2.0
                    status: "active"
                    cron_schedule: "0 0 1,15 * *"
                    created_at: "2025-10-27T10:00:00Z"
                    updated_at: "2025-10-27T10:00:00Z"
                    created_by: null
                    next_run_time: "2025-11-01T00:00:00Z"
                    scheduled_job_id: "660e8400-e29b-41d4-a716-446655440000"
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_cron:
                  summary: Invalid cron expression
                  value:
                    detail: "Invalid cron expression: expected 5 fields, got 3"
                    error_code: "INVALID_CRON_EXPRESSION"
                duplicate_name:
                  summary: Duplicate website name
                  value:
                    detail: "Website with name 'Example Site' already exists"
                    error_code: "DUPLICATE_WEBSITE_NAME"
                invalid_url:
                  summary: Invalid base URL
                  value:
                    detail: "base_url must start with http:// or https://"
                    error_code: "VALIDATION_ERROR"
                    field: "base_url"
        '422':
          description: Unprocessable Entity (validation error in request body)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                server_error:
                  value:
                    detail: "Internal server error: database connection failed"
                    error_code: "INTERNAL_ERROR"

  /api/v1/jobs/seed:
    post:
      tags:
        - Jobs
      summary: Submit a seed URL for crawling using an existing website template
      description: |
        Create a one-time crawl job using an existing website template configuration.

        This endpoint:
        1. Validates the seed URL and website_id
        2. Loads the website configuration from database
        3. Optionally accepts variable substitutions
        4. Creates a crawl job with pending status
        5. Returns job ID and status for tracking

        The job will use the website template's configuration including:
        - Crawl/scrape steps
        - Selectors for data extraction
        - Global settings (rate limits, timeouts, retries)
        - Browser configuration if needed

        Variables provided in the request will override template variables.
      operationId: createSeedJob
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSeedJobRequest'
            examples:
              simple_seed:
                summary: Simple seed URL with template
                value:
                  website_id: "550e8400-e29b-41d4-a716-446655440000"
                  seed_url: "https://example.com/articles/2025/technology"
                  variables:
                    category: "technology"
                    year: "2025"
              seed_with_priority:
                summary: Seed URL with custom priority
                value:
                  website_id: "550e8400-e29b-41d4-a716-446655440000"
                  seed_url: "https://example.com/breaking-news"
                  priority: 9
      responses:
        '201':
          description: Crawl job created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SeedJobResponse'
              examples:
                created:
                  value:
                    id: "770e8400-e29b-41d4-a716-446655440000"
                    website_id: "550e8400-e29b-41d4-a716-446655440000"
                    seed_url: "https://example.com/articles/2025/technology"
                    status: "pending"
                    job_type: "one_time"
                    priority: 5
                    scheduled_at: null
                    variables:
                      category: "technology"
                      year: "2025"
                    created_at: "2025-10-29T10:00:00Z"
                    updated_at: "2025-10-29T10:00:00Z"
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_website:
                  summary: Website not found
                  value:
                    detail: "Website with ID '550e8400-e29b-41d4-a716-446655440000' not found"
                    error_code: "WEBSITE_NOT_FOUND"
                invalid_url:
                  summary: Invalid seed URL
                  value:
                    detail: "seed_url must be a valid URL starting with http:// or https://"
                    error_code: "INVALID_URL"
                    field: "seed_url"
                inactive_website:
                  summary: Website is inactive
                  value:
                    detail: "Website 'Example Site' is inactive and cannot be used"
                    error_code: "WEBSITE_INACTIVE"
        '422':
          description: Unprocessable Entity (validation error in request body)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/jobs/seed-inline:
    post:
      tags:
        - Jobs
      summary: Submit a seed URL for crawling with inline configuration
      description: |
        Create a one-time crawl job with full inline configuration (Mode B - no template).

        This endpoint:
        1. Validates the seed URL and inline configuration
        2. Validates crawl steps and selectors
        3. Creates a crawl job with embedded configuration
        4. Returns job ID and status for tracking

        Unlike the template-based endpoint, this allows ad-hoc crawls without
        creating a website configuration first. The configuration is provided
        inline and stored with the job.

        Use cases:
        - One-off data collection tasks
        - Testing crawl configurations before creating a template
        - Dynamic crawling with programmatically generated configs
        - External integrations that generate configurations on-the-fly
      operationId: createSeedJobInline
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSeedJobInlineRequest'
            examples:
              simple_inline:
                summary: Simple inline crawl with HTTP method
                value:
                  seed_url: "https://example.com/articles"
                  steps:
                    - name: "scrape_article"
                      type: "scrape"
                      method: "http"
                      config:
                        url: "https://example.com/articles"
                      selectors:
                        title: "h1.title"
                        content: ".article-body"
                      output:
                        main_content_field: "content"
                  global_config:
                    rate_limit:
                      requests_per_second: 2.0
                    timeout:
                      http_request: 30
                  priority: 5
              browser_inline:
                summary: Browser-based inline crawl with Playwright
                value:
                  seed_url: "https://dynamic.example.com/products"
                  steps:
                    - name: "crawl_products"
                      type: "crawl"
                      method: "browser"
                      browser_type: "playwright"
                      config:
                        url: "https://dynamic.example.com/products"
                        wait_until: "networkidle"
                        actions:
                          - type: "wait"
                            selector: ".product-list"
                            timeout: 5000
                      selectors:
                        product_urls: ".product-card a"
                      output:
                        urls_field: "product_urls"
                  global_config:
                    rate_limit:
                      requests_per_second: 1.0
                      concurrent_pages: 3
                  priority: 7
                  variables:
                    api_key: "test_key_123"
      responses:
        '201':
          description: Crawl job created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SeedJobResponse'
              examples:
                created:
                  value:
                    id: "880e8400-e29b-41d4-a716-446655440000"
                    website_id: null
                    seed_url: "https://example.com/articles"
                    status: "pending"
                    job_type: "one_time"
                    priority: 5
                    scheduled_at: null
                    variables:
                      api_key: "test_key_123"
                    created_at: "2025-10-29T10:00:00Z"
                    updated_at: "2025-10-29T10:00:00Z"
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_url:
                  summary: Invalid seed URL
                  value:
                    detail: "seed_url must be a valid URL starting with http:// or https://"
                    error_code: "INVALID_URL"
                    field: "seed_url"
                invalid_config:
                  summary: Invalid configuration
                  value:
                    detail: "Invalid step configuration: missing required field 'method'"
                    error_code: "INVALID_CONFIGURATION"
                    field: "steps"
                empty_steps:
                  summary: Empty steps array
                  value:
                    detail: "At least one crawl step is required"
                    error_code: "VALIDATION_ERROR"
                    field: "steps"
        '422':
          description: Unprocessable Entity (validation error in request body)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/jobs/{job_id}/cancel:
    post:
      tags:
        - Jobs
      summary: Cancel a crawl job
      description: |
        Cancel a running or pending crawl job.

        This endpoint:
        1. Validates that the job exists
        2. Checks that the job is not already completed or cancelled
        3. Updates the job status to "cancelled"
        4. Sets a Redis cancellation flag for workers to detect
        5. Returns the updated job information

        Jobs in "completed" or "failed" status cannot be cancelled.
      operationId: cancelJob
      parameters:
        - name: job_id
          in: path
          required: true
          description: ID of the job to cancel
          schema:
            type: string
            format: uuid
            example: "770e8400-e29b-41d4-a716-446655440000"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelJobRequest'
            examples:
              with_reason:
                summary: Cancel with reason
                value:
                  reason: "User requested cancellation"
              without_reason:
                summary: Cancel without reason
                value: {}
      responses:
        '200':
          description: Job cancellation initiated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CancelJobResponse'
              examples:
                cancelled:
                  value:
                    id: "770e8400-e29b-41d4-a716-446655440000"
                    status: "cancelled"
                    message: "Job cancellation initiated"
                    cancelled_at: "2025-10-29T10:30:00Z"
        '400':
          description: Job cannot be cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                already_completed:
                  summary: Job already completed
                  value:
                    detail: "Job is already completed and cannot be cancelled"
                    error_code: "INVALID_JOB_STATUS"
                already_cancelled:
                  summary: Job already cancelled
                  value:
                    detail: "Job is already cancelled"
                    error_code: "ALREADY_CANCELLED"
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  value:
                    detail: "Job with ID '770e8400-e29b-41d4-a716-446655440000' not found"
                    error_code: "JOB_NOT_FOUND"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/jobs/{job_id}/ws-token:
    post:
      tags:
        - Jobs
      summary: Generate WebSocket token for log streaming
      description: |
        Generate a short-lived, single-use WebSocket authentication token.

        This endpoint:
        1. Validates that the job exists
        2. Generates a secure random token
        3. Stores it in Redis with 10-minute TTL
        4. Returns the token for WebSocket connection

        Use the returned token to connect to the WebSocket endpoint:
        `/ws/v1/jobs/{job_id}/logs?token={token}`

        Tokens expire after 10 minutes and are single-use only.
      operationId: generateWSToken
      parameters:
        - name: job_id
          in: path
          required: true
          description: ID of the job to generate token for
          schema:
            type: string
            format: uuid
            example: "770e8400-e29b-41d4-a716-446655440000"
      requestBody:
        required: false
        description: No request body required
        content:
          application/json:
            schema:
              type: object
            examples:
              empty:
                summary: No body needed
                value: {}
      responses:
        '200':
          description: Token generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WSTokenResponse'
              examples:
                success:
                  value:
                    token: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4"
                    expires_in: 600
                    job_id: "770e8400-e29b-41d4-a716-446655440000"
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  value:
                    detail: "Job with ID '770e8400-e29b-41d4-a716-446655440000' not found"
                    error_code: "JOB_NOT_FOUND"
        '500':
          description: Token generation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/jobs/{job_id}/logs:
    get:
      tags:
        - Jobs
      summary: Retrieve historical logs for a crawl job
      description: |
        Get historical logs for a completed or running crawl job with pagination and filtering.

        This endpoint:
        1. Validates that the job exists
        2. Retrieves logs from the database with optional filters
        3. Supports pagination for large log volumes
        4. Returns logs in chronological order (oldest first)

        **Filtering options:**
        - `log_level`: Filter by specific log level (DEBUG, INFO, WARNING, ERROR, CRITICAL)
        - `start_time`: Only return logs after this timestamp
        - `end_time`: Only return logs before this timestamp
        - `search`: Search for text in log messages (case-insensitive)

        **Pagination:**
        - Use `limit` and `offset` for pagination
        - Default limit is 100, max is 1000
        - `total` field indicates total logs matching filters
      operationId: getJobLogs
      parameters:
        - name: job_id
          in: path
          required: true
          description: ID of the job to retrieve logs for
          schema:
            type: string
            format: uuid
            example: "770e8400-e29b-41d4-a716-446655440000"
        - name: log_level
          in: query
          required: false
          description: Filter by log level
          schema:
            $ref: '#/components/schemas/LogLevelEnum'
        - name: start_time
          in: query
          required: false
          description: Filter logs after this timestamp (ISO 8601)
          schema:
            type: string
            format: date-time
            example: "2025-10-29T00:00:00Z"
        - name: end_time
          in: query
          required: false
          description: Filter logs before this timestamp (ISO 8601)
          schema:
            type: string
            format: date-time
            example: "2025-10-29T23:59:59Z"
        - name: search
          in: query
          required: false
          description: Search text in log messages (case-insensitive)
          schema:
            type: string
            minLength: 1
            maxLength: 500
            example: "error connecting"
        - name: limit
          in: query
          required: false
          description: Number of logs to return (max 1000)
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
            example: 100
        - name: offset
          in: query
          required: false
          description: Number of logs to skip for pagination
          schema:
            type: integer
            minimum: 0
            default: 0
            example: 0
      responses:
        '200':
          description: Logs retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CrawlLogsResponse'
              examples:
                success:
                  value:
                    logs:
                      - id: 12345
                        job_id: "770e8400-e29b-41d4-a716-446655440000"
                        website_id: "550e8400-e29b-41d4-a716-446655440000"
                        step_name: "crawl_step_1"
                        log_level: "INFO"
                        message: "Starting crawl for URL: https://example.com"
                        context:
                          url: "https://example.com"
                        trace_id: null
                        created_at: "2025-10-29T10:00:00Z"
                      - id: 12346
                        job_id: "770e8400-e29b-41d4-a716-446655440000"
                        website_id: "550e8400-e29b-41d4-a716-446655440000"
                        step_name: "crawl_step_1"
                        log_level: "INFO"
                        message: "Successfully fetched page"
                        context:
                          url: "https://example.com"
                          status_code: 200
                        trace_id: null
                        created_at: "2025-10-29T10:00:05Z"
                    total: 150
                    limit: 100
                    offset: 0
                empty:
                  summary: No logs found
                  value:
                    logs: []
                    total: 0
                    limit: 100
                    offset: 0
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  value:
                    detail: "Job with ID '770e8400-e29b-41d4-a716-446655440000' not found"
                    error_code: "JOB_NOT_FOUND"
        '422':
          description: Validation error (invalid parameters)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    # ============================================================================
    # Base Schemas
    # ============================================================================

    RootResponse:
      type: object
      required:
        - message
        - version
        - environment
      properties:
        message:
          type: string
          description: Welcome message
          example: "Welcome to Lexicon Crawler"
        version:
          type: string
          description: Application version
          example: "1.0.0"
        environment:
          type: string
          description: Environment name
          enum: [development, staging, production, testing]
          example: "development"

    HealthResponse:
      type: object
      required:
        - status
        - timestamp
        - checks
      properties:
        status:
          type: string
          description: Overall health status
          enum: [healthy, unhealthy]
          example: "healthy"
        timestamp:
          type: string
          format: date-time
          description: Check timestamp (ISO 8601)
          example: "2025-10-27T10:00:00Z"
        checks:
          type: object
          description: Individual service checks
          additionalProperties:
            type: string
          example:
            database: "connected"
            redis: "connected"

    ErrorResponse:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          description: Error message
          example: "Invalid cron expression"
        error_code:
          type: string
          description: Machine-readable error code
          example: "INVALID_CRON_EXPRESSION"
        field:
          type: string
          description: Field that caused the error (for validation errors)
          example: "cron_schedule"

    ValidationError:
      type: object
      required:
        - detail
      properties:
        detail:
          type: array
          items:
            type: object
            properties:
              loc:
                type: array
                items:
                  type: string
                description: Location of the error
              msg:
                type: string
                description: Error message
              type:
                type: string
                description: Error type

    # ============================================================================
    # Enums
    # ============================================================================

    StatusEnum:
      type: string
      enum:
        - pending
        - running
        - completed
        - failed
        - cancelled
        - active
        - inactive
      description: Status of website or job

    ScheduleTypeEnum:
      type: string
      enum:
        - once
        - recurring
      description: Schedule type for website crawling

    StepTypeEnum:
      type: string
      enum:
        - crawl
        - scrape
      description: Type of crawl step

    MethodEnum:
      type: string
      enum:
        - api
        - browser
        - http
      description: Method used for crawling/scraping

    BrowserTypeEnum:
      type: string
      enum:
        - playwright
        - undetected_chromedriver
      description: Browser type for automation

    LogLevelEnum:
      type: string
      enum:
        - DEBUG
        - INFO
        - WARNING
        - ERROR
        - CRITICAL
      description: Log level for crawl logs

    # ============================================================================
    # Configuration Schemas
    # ============================================================================

    ScheduleConfig:
      type: object
      properties:
        type:
          $ref: '#/components/schemas/ScheduleTypeEnum'
          default: recurring
        cron:
          type: string
          description: Cron expression (minute hour day month weekday)
          default: "0 0 1,15 * *"
          example: "0 0 1,15 * *"
          pattern: '^(\*|([0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9])|\*\/([0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9])) (\*|([0-9]|1[0-9]|2[0-3])|\*\/([0-9]|1[0-9]|2[0-3])) (\*|([1-9]|1[0-9]|2[0-9]|3[0-1])|\*\/([1-9]|1[0-9]|2[0-9]|3[0-1])) (\*|([1-9]|1[0-2])|\*\/([1-9]|1[0-2])) (\*|([0-6])|\*\/([0-6]))$'
        timezone:
          type: string
          description: Timezone for schedule
          default: "UTC"
          example: "UTC"
        enabled:
          type: boolean
          description: Enable/disable schedule
          default: true

    RateLimitConfig:
      type: object
      properties:
        requests_per_second:
          type: number
          format: float
          description: Max requests per second
          minimum: 0.1
          maximum: 100
          default: 2.0
        concurrent_pages:
          type: integer
          description: Max concurrent pages
          minimum: 1
          maximum: 50
          default: 5
        burst:
          type: integer
          description: Max burst requests
          minimum: 1
          maximum: 100
          default: 10

    TimeoutConfig:
      type: object
      properties:
        page_load:
          type: integer
          description: Page load timeout (seconds)
          minimum: 5
          maximum: 300
          default: 30
        selector_wait:
          type: integer
          description: Selector wait timeout (seconds)
          minimum: 1
          maximum: 60
          default: 10
        http_request:
          type: integer
          description: HTTP request timeout (seconds)
          minimum: 5
          maximum: 300
          default: 30

    RetryConfig:
      type: object
      properties:
        max_attempts:
          type: integer
          description: Maximum retry attempts
          minimum: 1
          maximum: 10
          default: 3
        backoff_strategy:
          type: string
          description: Backoff strategy
          enum: [exponential, linear, fixed]
          default: "exponential"
        backoff_base:
          type: number
          format: float
          description: Backoff base multiplier
          minimum: 1.0
          maximum: 10.0
          default: 2.0
        initial_delay:
          type: integer
          description: Initial delay (seconds)
          minimum: 1
          maximum: 60
          default: 1
        max_delay:
          type: integer
          description: Maximum delay (seconds)
          minimum: 1
          maximum: 3600
          default: 300

    GlobalConfig:
      type: object
      properties:
        rate_limit:
          $ref: '#/components/schemas/RateLimitConfig'
        timeout:
          $ref: '#/components/schemas/TimeoutConfig'
        retry:
          $ref: '#/components/schemas/RetryConfig'
        headers:
          type: object
          description: Global HTTP headers
          additionalProperties:
            type: string
          example:
            User-Agent: "Mozilla/5.0"
            Accept: "text/html"
        cookies:
          type: object
          description: Global cookies
          additionalProperties:
            type: string
      additionalProperties: true

    # ============================================================================
    # Step Configuration Schemas
    # ============================================================================

    PaginationConfig:
      type: object
      properties:
        enabled:
          type: boolean
          description: Enable pagination
          default: false
        type:
          type: string
          description: Pagination type
          enum: [page_based, offset_based, cursor_based, next_button, url_pattern]
          default: "page_based"
        page_param:
          type: string
          description: Page parameter name
          default: "page"
        start_page:
          type: integer
          description: Starting page number
          minimum: 1
          default: 1
        max_pages:
          type: integer
          description: Maximum pages to crawl
          minimum: 1
          maximum: 1000
          default: 100
        selector:
          type: string
          description: Next button selector (for browser)
          nullable: true
        wait_after_click:
          type: integer
          description: Wait time after clicking next (ms)
          minimum: 0
          default: 2000
          nullable: true
        url_template:
          type: string
          description: URL template with {page} placeholder
          nullable: true
          example: "https://example.com/page/{page}"
        min_content_length:
          type: integer
          description: Minimum content length to consider page non-empty (bytes)
          minimum: 0
          default: 100
        max_empty_responses:
          type: integer
          description: Maximum consecutive empty responses before stopping pagination
          minimum: 1
          maximum: 10
          default: 2
        track_content_hashes:
          type: boolean
          description: Enable duplicate content detection via hashing
          default: true
        track_urls:
          type: boolean
          description: Enable circular pagination detection (URL revisit tracking)
          default: true

    ActionConfig:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          description: Action type
          enum: [wait, click, fill, scroll, execute_script, hover]
        selector:
          type: string
          description: Element selector
          nullable: true
        value:
          type: string
          description: Value for fill actions or wait duration
          nullable: true
        timeout:
          type: integer
          description: Action timeout (ms)
          minimum: 0
          maximum: 60000
          default: 5000
        optional:
          type: boolean
          description: Continue if action fails
          default: false

    StepConfig:
      type: object
      properties:
        url:
          type: string
          description: URL to fetch (supports variables like {base_url})
          nullable: true
          example: "https://example.com/api/data"
        http_method:
          type: string
          description: HTTP method
          enum: [GET, POST, PUT, DELETE, PATCH]
          default: "GET"
        headers:
          type: object
          description: HTTP headers
          additionalProperties:
            type: string
        query_params:
          type: object
          description: Query parameters
          additionalProperties: true
        pagination:
          $ref: '#/components/schemas/PaginationConfig'
          nullable: true
        wait_until:
          type: string
          description: Browser wait condition
          enum: [load, domcontentloaded, networkidle]
          default: "networkidle"
          nullable: true
        actions:
          type: array
          description: Browser actions
          items:
            $ref: '#/components/schemas/ActionConfig'
        timeout:
          type: integer
          description: Request timeout (seconds)
          minimum: 1
          maximum: 300
          default: 30
      additionalProperties: true

    OutputConfig:
      type: object
      properties:
        urls_field:
          type: string
          description: Field name for extracted URLs
          default: "detail_urls"
          nullable: true
        main_content_field:
          type: string
          description: Main content field name
          default: "content"
          nullable: true
        metadata_fields:
          type: array
          description: Metadata fields to extract
          items:
            type: string
          default: []

    SelectorConfig:
      type: object
      required:
        - selector
      properties:
        selector:
          type: string
          description: CSS selector or XPath expression
          example: ".article-title"
        attribute:
          type: string
          description: Attribute to extract (text, html, href, src, etc.)
          default: "text"
          example: "text"
          nullable: true
        type:
          type: string
          description: Type of selector result
          enum: [single, array]
          default: "single"

    CrawlStep:
      type: object
      required:
        - name
        - type
        - method
      properties:
        name:
          type: string
          description: Unique step name
          minLength: 1
          maxLength: 255
          example: "crawl_list"
        type:
          $ref: '#/components/schemas/StepTypeEnum'
        description:
          type: string
          description: Human-readable description
          nullable: true
          example: "Crawl article list page"
        method:
          $ref: '#/components/schemas/MethodEnum'
        browser_type:
          $ref: '#/components/schemas/BrowserTypeEnum'
          nullable: true
        input_from:
          type: string
          description: Input data source from previous step (e.g., 'crawl_list.detail_urls')
          nullable: true
          example: "crawl_list.detail_urls"
        config:
          $ref: '#/components/schemas/StepConfig'
        selectors:
          type: object
          description: CSS/XPath selectors for data extraction
          additionalProperties:
            oneOf:
              - type: string
              - $ref: '#/components/schemas/SelectorConfig'
          example:
            title: "h1.title"
            content: ".article-body"
            links:
              selector: "a.article-link"
              attribute: "href"
              type: "array"
        output:
          $ref: '#/components/schemas/OutputConfig'

    # ============================================================================
    # Request/Response Schemas
    # ============================================================================

    CreateWebsiteRequest:
      type: object
      required:
        - name
        - base_url
        - steps
      properties:
        name:
          type: string
          description: Unique website name
          minLength: 1
          maxLength: 255
          example: "Example News Site"
        base_url:
          type: string
          description: Base URL of the website
          minLength: 1
          maxLength: 2048
          format: uri
          example: "https://example.com"
        description:
          type: string
          description: Optional description
          nullable: true
          example: "News site crawler for daily articles"
        schedule:
          $ref: '#/components/schemas/ScheduleConfig'
        steps:
          type: array
          description: List of crawl/scrape steps to execute
          minItems: 1
          items:
            $ref: '#/components/schemas/CrawlStep'
        global_config:
          $ref: '#/components/schemas/GlobalConfig'
        variables:
          type: object
          description: Variables for substitution in URLs and configurations
          additionalProperties: true
          example:
            api_key: "YOUR_API_KEY"
            user_id: "12345"

    WebsiteResponse:
      type: object
      required:
        - id
        - name
        - base_url
        - config
        - status
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Website ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          description: Website name
          example: "Example News Site"
        base_url:
          type: string
          format: uri
          description: Base URL
          example: "https://example.com"
        config:
          type: object
          description: Full configuration
          additionalProperties: true
        status:
          $ref: '#/components/schemas/StatusEnum'
        cron_schedule:
          type: string
          description: Cron schedule expression
          nullable: true
          example: "0 0 1,15 * *"
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
          example: "2025-10-27T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp
          example: "2025-10-27T10:00:00Z"
        created_by:
          type: string
          description: Creator identifier
          nullable: true
          example: "user@example.com"
        next_run_time:
          type: string
          format: date-time
          description: Next scheduled crawl time (if scheduled job exists)
          nullable: true
          example: "2025-11-01T00:00:00Z"
        scheduled_job_id:
          type: string
          format: uuid
          description: Associated scheduled job ID
          nullable: true
          example: "660e8400-e29b-41d4-a716-446655440000"

    CreateSeedJobRequest:
      type: object
      required:
        - website_id
        - seed_url
      properties:
        website_id:
          type: string
          format: uuid
          description: ID of the website template to use for configuration
          example: "550e8400-e29b-41d4-a716-446655440000"
        seed_url:
          type: string
          description: Starting URL for the crawl job
          minLength: 1
          maxLength: 2048
          format: uri
          example: "https://example.com/articles/2025/technology"
        variables:
          type: object
          description: Variables for substitution in URLs and configurations (overrides template variables)
          additionalProperties: true
          example:
            category: "technology"
            year: "2025"
            api_key: "YOUR_API_KEY"
        priority:
          type: integer
          description: Job priority (1=lowest, 10=highest)
          minimum: 1
          maximum: 10
          default: 5

    SeedJobResponse:
      type: object
      required:
        - id
        - seed_url
        - status
        - job_type
        - priority
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Crawl job ID
          example: "770e8400-e29b-41d4-a716-446655440000"
        website_id:
          type: string
          format: uuid
          description: Website template ID (null for inline config jobs)
          nullable: true
          example: "550e8400-e29b-41d4-a716-446655440000"
        seed_url:
          type: string
          format: uri
          description: Starting URL for crawl
          example: "https://example.com/articles/2025/technology"
        status:
          $ref: '#/components/schemas/StatusEnum'
        job_type:
          type: string
          enum: [one_time, scheduled, recurring]
          description: Job type
          example: "one_time"
        priority:
          type: integer
          description: Job priority
          example: 5
        scheduled_at:
          type: string
          format: date-time
          description: Scheduled execution time
          nullable: true
          example: null
        variables:
          type: object
          description: Variables used for this job
          additionalProperties: true
          nullable: true
          example:
            category: "technology"
            year: "2025"
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
          example: "2025-10-29T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp
          example: "2025-10-29T10:00:00Z"

    CreateSeedJobInlineRequest:
      type: object
      required:
        - seed_url
        - steps
      properties:
        seed_url:
          type: string
          description: Starting URL for the crawl job
          minLength: 1
          maxLength: 2048
          format: uri
          example: "https://example.com/articles"
        steps:
          type: array
          description: List of crawl/scrape steps to execute
          minItems: 1
          items:
            $ref: '#/components/schemas/CrawlStep'
        global_config:
          $ref: '#/components/schemas/GlobalConfig'
        variables:
          type: object
          description: Variables for substitution in URLs and configurations
          additionalProperties: true
          example:
            api_key: "YOUR_API_KEY"
            category: "technology"
        priority:
          type: integer
          description: Job priority (1=lowest, 10=highest)
          minimum: 1
          maximum: 10
          default: 5

    CancelJobRequest:
      type: object
      properties:
        reason:
          type: string
          description: Optional reason for cancellation
          maxLength: 500
          nullable: true
          example: "User requested cancellation"

    CancelJobResponse:
      type: object
      required:
        - id
        - status
        - message
        - cancelled_at
      properties:
        id:
          type: string
          format: uuid
          description: Job ID
          example: "770e8400-e29b-41d4-a716-446655440000"
        status:
          $ref: '#/components/schemas/StatusEnum'
        message:
          type: string
          description: Success message
          example: "Job cancellation initiated"
        cancelled_at:
          type: string
          format: date-time
          description: Cancellation timestamp
          example: "2025-10-29T10:30:00Z"

    WSTokenResponse:
      type: object
      required:
        - token
        - expires_in
        - job_id
      properties:
        token:
          type: string
          description: WebSocket authentication token (secure random string)
          minLength: 20
          example: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4"
        expires_in:
          type: integer
          description: Token expiration time in seconds
          example: 600
        job_id:
          type: string
          format: uuid
          description: Job ID this token is valid for
          example: "770e8400-e29b-41d4-a716-446655440000"

    CrawlLogEntry:
      type: object
      required:
        - id
        - job_id
        - website_id
        - log_level
        - message
        - created_at
      properties:
        id:
          type: integer
          format: int64
          description: Log entry ID
          example: 12345
        job_id:
          type: string
          format: uuid
          description: Job ID
          example: "770e8400-e29b-41d4-a716-446655440000"
        website_id:
          type: string
          format: uuid
          description: Website ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        step_name:
          type: string
          description: Step name that generated the log
          nullable: true
          example: "crawl_step_1"
        log_level:
          $ref: '#/components/schemas/LogLevelEnum'
        message:
          type: string
          description: Log message
          example: "Successfully fetched page: https://example.com"
        context:
          type: object
          description: Additional context data (JSON)
          nullable: true
          additionalProperties: true
          example:
            url: "https://example.com"
            status_code: 200
        trace_id:
          type: string
          format: uuid
          description: Trace ID for distributed tracing
          nullable: true
          example: "a1b2c3d4-e5f6-47h8-i9j0-k1l2m3n4o5p6"
        created_at:
          type: string
          format: date-time
          description: Log creation timestamp
          example: "2025-10-29T10:30:15Z"

    CrawlLogsResponse:
      type: object
      required:
        - logs
        - total
        - limit
        - offset
      properties:
        logs:
          type: array
          description: List of log entries
          items:
            $ref: '#/components/schemas/CrawlLogEntry'
        total:
          type: integer
          description: Total number of logs matching the filters
          example: 150
        limit:
          type: integer
          description: Number of logs per page
          example: 100
        offset:
          type: integer
          description: Offset for pagination
          example: 0

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT Bearer token authentication (future implementation)

security: []

# Code generation hints
x-codegen-settings:
  packageName: lexicon-crawler-client
  packageVersion: 1.0.0
  generateModels: true
  generateApis: true
