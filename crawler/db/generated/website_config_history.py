# Code generated by sqlc. DO NOT EDIT.
# versions:
#   sqlc v1.30.0
# source: website_config_history.sql
from typing import Any, AsyncIterator, Optional
import uuid

import sqlalchemy
import sqlalchemy.ext.asyncio

from crawler.db.generated import models


CREATE_CONFIG_HISTORY = """-- name: create_config_history \\:one
INSERT INTO website_config_history (
    website_id,
    version,
    config,
    changed_by,
    change_reason
) VALUES (
    :p1,
    :p2,
    :p3,
    :p4,
    :p5
)
RETURNING id, website_id, version, config, changed_by, change_reason, created_at
"""


GET_CONFIG_BY_VERSION = """-- name: get_config_by_version \\:one
SELECT id, website_id, version, config, changed_by, change_reason, created_at FROM website_config_history
WHERE website_id = :p1
  AND version = :p2
"""


GET_CONFIG_HISTORY = """-- name: get_config_history \\:many
SELECT id, website_id, version, config, changed_by, change_reason, created_at FROM website_config_history
WHERE website_id = :p1
ORDER BY version DESC
OFFSET :p2 LIMIT :p3
"""


GET_LATEST_CONFIG_VERSION = """-- name: get_latest_config_version \\:one
SELECT COALESCE(MAX(version), 0) AS latest_version
FROM website_config_history
WHERE website_id = :p1
"""


class AsyncQuerier:
    def __init__(self, conn: sqlalchemy.ext.asyncio.AsyncConnection):
        self._conn = conn

    async def create_config_history(self, *, website_id: uuid.UUID, version: int, config: Any, changed_by: Optional[str], change_reason: Optional[str]) -> Optional[models.WebsiteConfigHistory]:
        row = (await self._conn.execute(sqlalchemy.text(CREATE_CONFIG_HISTORY), {
            "p1": website_id,
            "p2": version,
            "p3": config,
            "p4": changed_by,
            "p5": change_reason,
        })).first()
        if row is None:
            return None
        return models.WebsiteConfigHistory(
            id=row[0],
            website_id=row[1],
            version=row[2],
            config=row[3],
            changed_by=row[4],
            change_reason=row[5],
            created_at=row[6],
        )

    async def get_config_by_version(self, *, website_id: uuid.UUID, version: int) -> Optional[models.WebsiteConfigHistory]:
        row = (await self._conn.execute(sqlalchemy.text(GET_CONFIG_BY_VERSION), {"p1": website_id, "p2": version})).first()
        if row is None:
            return None
        return models.WebsiteConfigHistory(
            id=row[0],
            website_id=row[1],
            version=row[2],
            config=row[3],
            changed_by=row[4],
            change_reason=row[5],
            created_at=row[6],
        )

    async def get_config_history(self, *, website_id: uuid.UUID, offset_count: int, limit_count: int) -> AsyncIterator[models.WebsiteConfigHistory]:
        result = await self._conn.stream(sqlalchemy.text(GET_CONFIG_HISTORY), {"p1": website_id, "p2": offset_count, "p3": limit_count})
        async for row in result:
            yield models.WebsiteConfigHistory(
                id=row[0],
                website_id=row[1],
                version=row[2],
                config=row[3],
                changed_by=row[4],
                change_reason=row[5],
                created_at=row[6],
            )

    async def get_latest_config_version(self, *, website_id: uuid.UUID) -> Optional[Optional[Any]]:
        row = (await self._conn.execute(sqlalchemy.text(GET_LATEST_CONFIG_VERSION), {"p1": website_id})).first()
        if row is None:
            return None
        return row[0]
