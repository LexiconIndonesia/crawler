name: CI
permissions:
    contents: read

on:
    pull_request:
        branches: [main]
        paths:
            - "**.py"
            - "pyproject.toml"
            - "requirements*.txt"
            - "openapi.yaml"
            - ".github/workflows/ci.yml"
            - "Dockerfile"
            - "docker-compose.yml"
    # Only run on PR, not on push to main to avoid duplicate runs

jobs:
    quality-checks:
        name: Code Quality Checks
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v5
            - name: Install uv
              uses: astral-sh/setup-uv@v7
              with:
                  enable-cache: true
                  cache-dependency-glob: "pyproject.toml"
            - name: Set up Python 3.14
              run: uv python install 3.14
            - name: Install dependencies
              run: uv sync
            - name: Install OpenAPI Generator CLI
              run: |
                  npm install -g @openapitools/openapi-generator-cli
            - name: Validate OpenAPI contract
              run: |
                  echo "Validating OpenAPI specification..."
                  openapi-generator-cli validate -i openapi.yaml 2>&1 | grep -v "Unable to query repository" | head -10 || true
                  echo "✅ OpenAPI spec validation complete"
            - name: Run all quality checks
              run: |
                  echo "Running format check..."
                  uv run ruff format --check .

                  echo "Running linter..."
                  uv run ruff check .

                  echo "Running type checker..."
                  uv run mypy . || true

    unit-tests:
        name: Unit Tests
        runs-on: ubuntu-latest
        needs: quality-checks
        steps:
            - name: Checkout code
              uses: actions/checkout@v5
            - name: Install uv
              uses: astral-sh/setup-uv@v7
              with:
                  enable-cache: true
                  cache-dependency-glob: "pyproject.toml"
            - name: Set up Python 3.14
              run: uv python install 3.14
            - name: Install dependencies
              run: uv sync
            - name: Generate OpenAPI models
              run: |
                  echo "Generating Pydantic models from OpenAPI spec..."
                  mkdir -p crawler/api/generated
                  uv run datamodel-codegen \
                    --input openapi.yaml \
                    --output crawler/api/generated/models.py \
                    --input-file-type openapi \
                    --output-model-type pydantic_v2.BaseModel \
                    --use-standard-collections \
                    --use-schema-description \
                    --field-constraints \
                    --use-default \
                    --use-annotated \
                    --use-double-quotes \
                    --target-python-version 3.11
                  echo "✅ Models generated successfully"
            - name: Run unit tests
              run: |
                  echo "Running unit tests..."
                  uv run pytest tests/unit/ -q --maxfail=3

    integration-tests:
        name: Integration Tests
        runs-on: ubuntu-latest
        needs: quality-checks
        steps:
            - name: Checkout code
              uses: actions/checkout@v5
            - name: Install uv
              uses: astral-sh/setup-uv@v7
              with:
                  enable-cache: true
                  cache-dependency-glob: "pyproject.toml"
            - name: Set up Python 3.14
              run: uv python install 3.14
            - name: Install dependencies
              run: uv sync
            - name: Generate OpenAPI models
              run: |
                  echo "Generating Pydantic models from OpenAPI spec..."
                  mkdir -p crawler/api/generated
                  uv run datamodel-codegen \
                    --input openapi.yaml \
                    --output crawler/api/generated/models.py \
                    --input-file-type openapi \
                    --output-model-type pydantic_v2.BaseModel \
                    --use-standard-collections \
                    --use-schema-description \
                    --field-constraints \
                    --use-default \
                    --use-annotated \
                    --use-double-quotes \
                    --target-python-version 3.11
                  echo "✅ Models generated successfully"
            - name: Start services with docker-compose
              run: |
                  echo "Starting PostgreSQL, Redis, and NATS..."
                  docker compose up -d postgres redis nats
                  echo "Waiting for services to be healthy..."
                  sleep 10
                  docker compose ps
            - name: Create test database
              run: |
                  echo "Creating test database..."
                  docker compose exec -T postgres psql -U crawler -c "CREATE DATABASE crawler_test;" || true
            - name: Run integration tests
              env:
                  TEST_DATABASE_URL: postgresql+asyncpg://crawler:crawler@localhost:5432/crawler_test
                  REDIS_URL: redis://localhost:6379
                  NATS_URL: nats://localhost:4222
                  ENVIRONMENT: testing
              run: |
                  echo "Running integration tests..."
                  uv run pytest tests/integration/ -q --maxfail=3
            - name: Stop services
              if: always()
              run: docker compose down -v
